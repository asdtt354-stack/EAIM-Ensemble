<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAIM ìŠ¤ë§ˆíŠ¸ ì•™ìƒë¸”</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6C5CE7; --accent: #00B894; --bg: #dfe6e9; --text: #2d3436; --red: #ff7675; }
        body { font-family: 'Jua', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; text-align: center; user-select: none; }
        .hidden { display: none !important; }
        
        /* ëŒ€ë¬¸(Intro) */
        #intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #74b9ff, #6C5CE7); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 20px; box-sizing: border-box; }
        .intro-box { background: rgba(255, 255, 255, 0.2); padding: 30px; border-radius: 20px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0,0,0,0.2); max-width: 600px; width: 90%; }
        .btn-start { background: #ffeaa7; color: #2d3436; border: none; padding: 15px 40px; font-size: 1.5em; border-radius: 50px; cursor: pointer; font-family: 'Jua'; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .btn-start:hover { transform: scale(1.05); background: #fff; }

        /* ë©”ì¸ ì‘ì—… ê³µê°„ */
        .workspace { background: white; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); max-width: 800px; margin: 20px auto; }
        .step-title { font-size: 1.4em; color: var(--primary); margin-bottom: 15px; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 30px; font-size: 1.1em; cursor: pointer; font-family: 'Jua'; margin-top: 15px; transition: 0.2s; }
        .btn-stop { background: var(--red); color: white; border: none; padding: 10px 20px; border-radius: 30px; font-size: 1.1em; cursor: pointer; font-family: 'Jua'; margin-left: 5px; }
        .btn-main:active, .btn-stop:active { transform: scale(0.95); }

        .timeline-container { background: white; padding: 20px; border-radius: 20px; margin: 20px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-height: 100px; max-width: 700px; }
        .story-block { background: #f1f2f6; border-left: 8px solid #ccc; padding: 15px; margin: 10px 0; text-align: left; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s; }

        .emotion-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .color-btn { height: 60px; border-radius: 15px; border: 3px solid white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .color-btn.selected { transform: scale(1.1); border-color: #2d3436; font-weight: bold; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        .color-btn span { font-size: 12px; margin-top: 2px; color: rgba(0,0,0,0.6); pointer-events: none; }

        .story-tabs { display: flex; justify-content: space-between; background: #f1f2f6; border-radius: 15px; padding: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; border: none; background: transparent; padding: 10px; font-family: 'Jua'; font-size: 1.1em; color: #b2bec3; cursor: pointer; border-radius: 10px; }
        .tab-btn.active { background: white; color: var(--primary); font-weight: bold; }

        .input-area { min-height: 80px; display: flex; align-items: center; justify-content: center; }
        .big-input { width: 80%; padding: 15px; border: 2px solid var(--primary); border-radius: 15px; font-family: 'Jua'; font-size: 1.2em; text-align: center; outline: none; }
        .preview-input { width: 90%; background: #ffeaa7; padding: 15px; border-radius: 15px; margin-top: 20px; color: #2d3436; font-size: 1.2em; text-align: center; border: none; font-family: 'Jua'; }

        .rhythm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .rhythm-card { border: 2px solid #ddd; border-radius: 15px; padding: 10px; cursor: pointer; background: white; }
        .rhythm-card.selected { border-color: var(--primary); background: #f0f0ff; transform: scale(1.02); }

        .composer-console { background: #2d3436; padding: 20px; border-radius: 20px; color: white; }
        .score-vis { height: 70px; display: flex; justify-content: center; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #636e72; padding-bottom: 5px; }
        .beat-box { width: 60px; height: 100%; background: rgba(255,255,255,0.1); border-radius: 5px; display: flex; align-items: flex-end; justify-content: center; gap: 2px; padding: 2px; position:relative; overflow: hidden; }
        .beat-box.active { background: rgba(255,255,255,0.2); border: 1px solid var(--accent); }
        .sub-note { background: var(--accent); opacity: 0.3; border-radius: 3px; height: 0; width: 100%; }
        .sub-note.filled { opacity: 1; }

        .controls { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px; text-align: left; }
        .control-label { font-size: 0.9em; color: #dfe6e9; margin-bottom: 5px; margin-top: 10px; }

        .inst-opts { display: flex; justify-content: center; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn-inst { padding: 8px 10px; border-radius: 15px; border: 2px solid #636e72; background: #636e72; color: #b2bec3; font-family: 'Jua'; cursor: pointer; font-size: 0.9em; transition: 0.2s; }
        .btn-inst:hover { background: rgba(255,255,255,0.1); }
        .btn-inst.active { border-color: #fab1a0; background: #fab1a0; color: #2d3436; font-weight: bold; transform: scale(1.05); box-shadow: 0 0 10px #fab1a0; }

        .note-len-opts { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .btn-len { padding: 8px 10px; border-radius: 20px; border: 2px solid #b2bec3; background: transparent; color: #b2bec3; font-family: 'Jua'; cursor: pointer; margin-bottom:5px; }
        .btn-len.active { border-color: var(--accent); color: white; background: var(--accent); font-weight: bold; }

        .train-container { display: flex; gap: 5px; margin-bottom: 5px; }
        .var-car { flex: 1; min-width: 60px; border: 2px solid #b2bec3; border-radius: 8px; padding: 8px 4px; background: transparent; color: #b2bec3; font-family: 'Jua'; cursor: pointer; font-size: 0.85em; transition: 0.2s; white-space: nowrap; }
        .var-car.head { background: #636e72; color: white; border: none; cursor: default; flex: 1.2; text-align: center; }
        .var-car:hover:not(.head) { background: rgba(255,255,255,0.1); }
        .var-car[data-rtype="quarter"] { border-color: #fab1a0; color: #fab1a0; }
        .var-car[data-rtype="eighth"] { border-color: #74b9ff; color: #74b9ff; }
        .var-car[data-rtype="swing"] { border-color: #a29bfe; color: #a29bfe; }
        .var-car[data-rtype="ending"] { border-color: #00B894; color: #00B894; font-weight:bold; }
        .var-car[data-ptype^="end-"] { border-color: #a29bfe; color: white; background: #a29bfe; font-weight: bold; }

        input[type=range] { width: 100%; accent-color: var(--accent); }
        
        /* ğŸ¹ í”¼ì•„ë…¸ ê±´ë°˜ ìŠ¤íƒ€ì¼ (ì—…ê·¸ë ˆì´ë“œ) */
        .piano-keys { 
            display: flex; justify-content: center; margin-top: 15px; position: relative; 
            background: #2d3436; padding: 10px 0; border-radius: 10px;
        }
        .key { 
            width: 40px; height: 140px; background: white; margin: 0 2px; 
            border-radius: 0 0 5px 5px; cursor: pointer; border-bottom: 5px solid #b2bec3; 
            display: flex; align-items: flex-end; justify-content: center; padding-bottom: 5px;
            font-size: 14px; font-weight: bold; color: #2d3436; position: relative; z-index: 1;
        }
        /* ê²€ì€ ê±´ë°˜ (ëª¨ì–‘ë§Œ) */
        .key.black {
            width: 26px; height: 90px; background: #2d3436; border: 2px solid #000;
            border-bottom: 4px solid #000; position: absolute; top: 10px; z-index: 2;
            cursor: default; pointer-events: none; /* í´ë¦­ ë°©ì§€ */
        }
        .key:active, .key.pressed { background: #ffeaa7; transform: translateY(2px); border-bottom-width: 2px; }
        .key-label { pointer-events: none; }

        /* ì§ˆë¬¸ ì¹´ë“œ & ì €ì¥ ì˜ì—­ */
        .question-card { background: #f0f0ff; border: 2px dashed var(--primary); padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .q-text { font-size: 1.3em; font-weight: bold; color: #2d3436; margin-bottom: 15px; white-space: pre-wrap; line-height: 1.4; }
        .input-box { width: 95%; height: 100px; padding: 15px; border-radius: 15px; border: 2px solid #b2bec3; font-family: 'Jua'; font-size: 1.1em; resize: none; margin-top:10px; }
        .save-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="intro-screen">
        <div class="intro-box">
            <div style="font-size:2.5em; margin-bottom:10px;">ğŸ¼ EAIM ìŠ¤ë§ˆíŠ¸ ì•™ìƒë¸”</div>
            <div style="font-size:1.2em; margin-bottom:30px;">ë‚˜ë§Œì˜ ê°ì •ì„ ë‹´ì•„<br>ì„¸ìƒì— í•˜ë‚˜ë¿ì¸ ìŒì•…ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</div>
            <div style="text-align:left; background:rgba(0,0,0,0.1); padding:15px; border-radius:10px; margin-bottom:20px;">
                <div1ï¸âƒ£ <b>ê°ì • ì„ íƒ:</b> ì˜¤ëŠ˜ ë‚˜ì˜ ê¸°ë¶„ì€?</div>
                <div>2ï¸âƒ£ <b>ë¦¬ë“¬ ê²°ì •:</b> ì¿µì§ì¿µì§, ì–´ë–¤ ë¹„íŠ¸?</div>
                <div>3ï¸âƒ£ <b>ë©œë¡œë”” í†¡í†¡:</b> ê±´ë°˜ì„ ëˆŒëŸ¬ ì‘ê³¡!</div>
                <div>4ï¸âƒ£ <b>íƒêµ¬ & ê³µìœ :</b> ë‚´ ìŒì•…ì˜ ì˜ë¯¸ ì°¾ê¸°</div>
            </div>
            <button class="btn-start" onclick="startApp()">ì‹œì‘í•˜ê¸° ğŸš€</button>
        </div>
    </div>

    <div class="timeline-container hidden" id="main-timeline">
        <h3 style="margin:0; color:#b2bec3;">ìš°ë¦¬ì˜ ìŒì•… ì´ì•¼ê¸°</h3>
        <div id="timeline-list"></div>
        <div style="margin-top:10px;">
            <button id="btn-play-all" class="btn-main hidden" style="background:#e17055" onclick="playWholeStory()">â–¶ï¸ ì „ì²´ ê°ìƒ</button>
            <button id="btn-stop-all" class="btn-stop hidden" onclick="stopAllSound()">â–  ì •ì§€</button>
        </div>
    </div>

    <div class="workspace hidden" id="main-workspace">
        
        <section id="step-1">
            <div class="step-title">Step 1. ê°ì •ê³¼ ì´ì•¼ê¸° ì¡°ê°</div>
            <div class="emotion-grid">
                <div class="color-btn" style="background:#ffeaa7" onclick="setEmotion(this, 'happy', '#ffeaa7')">ğŸ˜Š<span>ê¸°ì¨</span></div>
                <div class="color-btn" style="background:#fdcb6e" onclick="setEmotion(this, 'excited', '#fdcb6e')">ğŸ‰<span>ì‹ ë‚¨</span></div>
                <div class="color-btn" style="background:#e84393" onclick="setEmotion(this, 'surprised', '#e84393')">ğŸ˜²<span>ë†€ëŒ</span></div>
                <div class="color-btn" style="background:#74b9ff" onclick="setEmotion(this, 'sad', '#74b9ff')">ğŸ’§<span>ìŠ¬í””</span></div>
                <div class="color-btn" style="background:#dfe6e9" onclick="setEmotion(this, 'lonely', '#dfe6e9')">ğŸ‚<span>ì™¸ë¡œì›€</span></div>
                <div class="color-btn" style="background:#ff7675" onclick="setEmotion(this, 'angry', '#ff7675')">ğŸ”¥<span>í™”ë‚¨</span></div>
                <div class="color-btn" style="background:#636e72; color:white;" onclick="setEmotion(this, 'scary', '#636e72')">ğŸ˜±<span>ë¬´ì„œì›€</span></div>
                <div class="color-btn" style="background:#a29bfe" onclick="setEmotion(this, 'dream', '#a29bfe')">ğŸ”®<span>ì‹ ë¹„</span></div>
                <div class="color-btn" style="background:#00b894" onclick="setEmotion(this, 'proud', '#00b894')">ğŸ†<span>ë¿Œë“¯</span></div>
                <div class="color-btn" style="background:#55efc4" onclick="setEmotion(this, 'calm', '#55efc4')">ğŸŒ¿<span>í‰ì˜¨</span></div>
            </div>
            <div class="story-tabs">
                <button class="tab-btn active" onclick="switchTab('when')">ğŸ•’ ì–¸ì œ</button>
                <button class="tab-btn" onclick="switchTab('where')">ğŸ“ ì–´ë””ì„œ</button>
                <button class="tab-btn" onclick="switchTab('who')">ğŸ‘¤ ëˆ„ê°€</button>
                <button class="tab-btn" onclick="switchTab('what')">ğŸˆ ë¬´ì—‡ì„</button>
            </div>
            <div class="input-area">
                <input type="text" id="input-when" class="big-input" placeholder="ì˜ˆ: ì–´ëŠ ë§‘ì€ ì•„ì¹¨" oninput="updateText()">
                <input type="text" id="input-where" class="big-input hidden" placeholder="ì˜ˆ: ë¬´ì§€ê°œ ë™ì‚° (ë‹¨ì–´ë§Œ)" oninput="updateText()">
                <input type="text" id="input-who" class="big-input hidden" placeholder="ì˜ˆ: ì¹œêµ¬ì™€ (ììœ ë¡­ê²Œ)" oninput="updateText()">
                <input type="text" id="input-what" class="big-input hidden" placeholder="ì˜ˆ: ì¶¤ì„ ì·„ì–´ (ì„œìˆ ì–´)" oninput="updateText()">
            </div>
            <input type="text" id="preview-msg" class="preview-input" value="(ê°ì •ì„ ì„ íƒí•˜ë©´ ì´ì•¼ê¸°ê°€ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤)" placeholder="ë‚´ìš©ì„ ììœ ë¡­ê²Œ ìˆ˜ì •í•´ë³´ì„¸ìš”!">
            <button class="btn-main" onclick="nextStep(2)">ì´ì•¼ê¸° ì™„ì„±! ë¦¬ë“¬ ì •í•˜ê¸° ğŸ‘‰</button>
        </section>

        <section id="step-2" class="hidden">
            <div class="step-title">Step 2. ë¦¬ë“¬ì„ ë“£ê³  ê³¨ë¼ë³´ì„¸ìš”</div>
            <div class="rhythm-grid">
                <div class="rhythm-card" onclick="previewRhythm(this, 'ballad')"><div class="rhythm-label">â˜ï¸ ë°œë¼ë“œ (4/4)</div><div class="rhythm-desc">ë¶€ë“œëŸ¬ìš´ í”¼ì•„ë…¸</div></div>
                <div class="rhythm-card" onclick="previewRhythm(this, 'hiphop')"><div class="rhythm-label">ğŸ€ í™í•© (4/4)</div><div class="rhythm-desc">ì¿µ-ì§-ì§ ë¹„íŠ¸</div></div>
                <div class="rhythm-card" onclick="previewRhythm(this, 'march')"><div class="rhythm-label">ğŸ‘Ÿ í–‰ì§„ (4/4)</div><div class="rhythm-desc">ì”©ì”©í•œ ë“œëŸ¼</div></div>
                <div class="rhythm-card" onclick="previewRhythm(this, 'waltz')"><div class="rhythm-label">ğŸ’ƒ ì™ˆì¸  (3/4)</div><div class="rhythm-desc">3ë°•ì ì¿µì§ì§</div></div>
                <div class="rhythm-card" onclick="previewRhythm(this, 'funk')"><div class="rhythm-label">ğŸ¸ í‘í¬ (4/4)</div><div class="rhythm-desc">ìª¼ê°œì§€ëŠ” 16ë¹„íŠ¸</div></div>
                <div class="rhythm-card" onclick="previewRhythm(this, 'bossa')"><div class="rhythm-label">ğŸ–ï¸ ë³´ì‚¬ë…¸ë°” (4/4)</div><div class="rhythm-desc">ë¼í‹´ ì‹±ì½”í˜ì´ì…˜</div></div>
            </div>
            <button class="btn-main" onclick="nextStep(3)">ì´ ë¦¬ë“¬ìœ¼ë¡œ ê²°ì •! ğŸ‘‰</button>
        </section>

        <section id="step-3" class="hidden">
            <div class="step-title">Step 3. ì‘ê³¡ & ë³€ì£¼ (í•©ì£¼ + ë¦¬ë“¬ + ë©œë¡œë””)</div>
            <div class="composer-console">
                <div class="control-label">ğŸ» ì•…ê¸° í•©ì£¼ ì„ íƒ (ì›í•˜ëŠ” ë§Œí¼ ëˆ„ë¥´ì„¸ìš”!)</div>
                <div class="inst-opts">
                    <button class="btn-inst active" id="inst-piano" onclick="toggleInstrument('piano')">ğŸ¹ í”¼ì•„ë…¸</button>
                    <button class="btn-inst" id="inst-violin" onclick="toggleInstrument('violin')">ğŸ» ë°”ì´ì˜¬ë¦°</button>
                    <button class="btn-inst" id="inst-cello" onclick="toggleInstrument('cello')">ğŸ» ì²¼ë¡œ</button>
                    <button class="btn-inst" id="inst-flute" onclick="toggleInstrument('flute')">ğŸŒ¬ï¸ í”Œë£¨íŠ¸</button>
                    <button class="btn-inst" id="inst-bassoon" onclick="toggleInstrument('bassoon')">ğŸªµ ë°”ìˆœ</button>
                </div>

                <div class="note-len-opts">
                    <button class="btn-len" id="len-eighth" onclick="setNoteLen('eighth')">â™« ë°˜ë°•ì</button>
                    <button class="btn-len active" id="len-quarter" onclick="setNoteLen('quarter')">â™© í•œë°•ì</button>
                    <button class="btn-len" id="len-swing" onclick="setNoteLen('swing')">â™ªâ™© ìŠ¤ìœ™</button>
                    <button class="btn-len" id="len-half" onclick="setNoteLen('half')">ğ…—ğ…¥ ë‘ë°•ì</button>
                    <button class="btn-len" id="len-dotted" onclick="setNoteLen('dotted')">ğ…—ğ…¥. ì„¸ë°•ì</button>
                </div>

                <div class="score-vis" id="score-container"></div>
                
                <div class="controls">
                    <div class="control-label">ğŸš‚ ë¦¬ë“¬(Rhythm) ë³€ì£¼</div>
                    <div class="train-container">
                        <button class="var-car head">1.ë‚˜ì˜ ë©œë¡œë””</button>
                        <button class="var-car" id="btn-rvar-2" data-rtype="repeat" onclick="cycleRhythm(2)">2. ğŸ”„ ê·¸ëŒ€ë¡œ</button>
                        <button class="var-car" id="btn-rvar-3" data-rtype="repeat" onclick="cycleRhythm(3)">3. ğŸ”„ ê·¸ëŒ€ë¡œ</button>
                        <button class="var-car" id="btn-rvar-4" data-rtype="repeat" onclick="cycleRhythm(4)">4. ğŸ”„ ê·¸ëŒ€ë¡œ</button>
                    </div>

                    <div class="control-label">ğŸ¢ ë©œë¡œë””(Melody) ë³€ì£¼</div>
                    <div class="train-container">
                        <button class="var-car head" style="background:#2d3436; border:1px solid #636e72;">ìŒë†’ì´</button>
                        <button class="var-car" id="btn-pvar-2" data-ptype="same" onclick="cyclePitch(2)">2. â” ê·¸ëŒ€ë¡œ</button>
                        <button class="var-car" id="btn-pvar-3" data-ptype="same" onclick="cyclePitch(3)">3. â” ê·¸ëŒ€ë¡œ</button>
                        <button class="var-car" id="btn-pvar-4" data-ptype="same" onclick="cyclePitch(4)">4. â” ê·¸ëŒ€ë¡œ</button>
                    </div>
                    
                    <div style="display:flex; justify-content: space-between; margin-top:15px; align-items:center;">
                        <div style="width:48%">
                            <label>ğŸ¢ ë¹ ë¥´ê¸° ğŸ‡</label>
                            <input type="range" id="tempo-slider" min="0.5" max="2.0" step="0.1" value="1.0" oninput="previewIfReady()">
                        </div>
                        <div style="width:48%; display:flex; gap:5px;">
                            <button class="btn-main" style="padding:5px 10px; margin:0; font-size:0.9em; flex:1; background:#00B894;" onclick="previewMelody()">ğŸ”Š ì „ì²´ ë“£ê¸°</button>
                            <button class="btn-stop" style="padding:5px 10px; margin:0; font-size:0.9em; flex:0.5;" onclick="stopAllSound()">â– </button>
                        </div>
                    </div>
                </div>

                <div class="piano-keys" id="piano-area"></div>
                <div id="status-msg" style="margin-top:10px;">ë©œë¡œë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
            </div>
            
            <div id="save-controls" class="hidden" style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
                <button class="btn-main" style="background:#0984e3; width:45%;" onclick="saveAndContinue()">â• ì´ì–´ì„œ ê³„ì† ë§Œë“¤ê¸°</button>
                <button class="btn-main" style="background:#00b894; width:45%;" onclick="saveAndFinish()">ğŸ ì‘ê³¡ ëë‚´ê¸° (íƒêµ¬ë¡œ)</button>
            </div>

            <button class="btn-main" style="background:#636e72; font-size:0.9em; margin-top:10px;" onclick="resetMelody()">ğŸ”„ ë‹¤ì‹œ ì“°ê¸°</button>
        </section>

        <section id="step-4" class="hidden">
            <div class="step-title">Step 4. ë‚˜ì˜ ìŒì•… íƒêµ¬ & ì €ì¥</div>
            
            <div class="question-card">
                <div style="color:#636e72; font-size:0.9em;">ğŸ¤” ì •ë‹µì´ ì—†ëŠ” ì§ˆë¬¸</div>
                <div id="inquiry-q" class="q-text"></div>
                <button class="btn-main" style="padding:5px 15px; font-size:0.8em; margin-bottom:10px;" onclick="refreshQuestion()">ğŸ”„ ë‹¤ë¥¸ ì§ˆë¬¸ ë½‘ê¸°</button>
                <textarea id="inquiry-a" class="input-box" placeholder="ë‚˜ì˜ ìƒê°ì„ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”..."></textarea>
            </div>

            <div class="save-grid">
                <button class="btn-main" style="background:#00b894;" onclick="downloadAudio()">ğŸ§ ë…¹ìŒ ë° ë‹¤ìš´ë¡œë“œ (.webm)</button>
                <button class="btn-main" style="background:#fab1a0;" onclick="saveText()">ğŸ“ íƒêµ¬ ì¼ì§€ ì €ì¥ (.txt)</button>
            </div>
            <button class="btn-main" style="background:#636e72; width:100%; margin-top:15px;" onclick="location.reload()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
        </section>

    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let activeNodes = [];
        let activeTimeouts = [];
        let destNode = audioCtx.createMediaStreamDestination(); 

        let current = { 
            emo: '', rhythm: '', maxBeats: 4, instruments: ['piano'], melody: [], 
            tempo: 1.0, artic: 'long', text: '', rhythmVars: ['repeat','repeat','repeat'], 
            pitchVars: ['same','same','same'], noteLenMode: 'quarter', beatIdx: 0, 
            when: '', where: '', who: '', what: '', color: '' 
        };

        const templates = {
            happy: "{when} {where} {who} ê¸°ë¶„ ì¢‹ê²Œ {act} ğŸ˜Š", excited: "{when} {where} {who} ì‹ ë‚˜ê²Œ {act} ğŸ‰", sad: "{when} {where} {who} ìŠ¬í”„ê²Œ {act} ğŸ’§",
            lonely: "{when} {where} {who} í˜¼ì ì™¸ë¡­ê²Œ {act} ğŸ‚", angry: "{when} {where} {who} í™”ê°€ ë‚˜ì„œ {act} ğŸ”¥", scary: "{when} ê¹œê¹œí•œ {where} {who} ë¬´ì„­ê²Œ {act} ğŸ˜±",
            dream: "{when} ê¿ˆì† {where} {who} ì‹ ë¹„ë¡­ê²Œ {act} ğŸ”®", proud: "{when} {where} {who} ìë‘ìŠ¤ëŸ½ê²Œ {act} ğŸ†", calm: "{when} {where} {who} í‰ì˜¨í•˜ê²Œ {act} ğŸŒ¿",
            surprised: "{when} {where} {who} ê¹œì§ ë†€ë¼ {act} ğŸ˜²"
        };

        // ğŸ”¥ ë³µêµ¬ëœ ì§ˆë¬¸ ë³´ë”°ë¦¬ (ì¤‘ìš”!)
        const inquiryPool = {
            happy: ["ìš°ë¦¬ê°€ ë§Œë“  '[story]' ì´ì•¼ê¸°ì—ì„œ ê°€ì¥ ë¹›ë‚˜ëŠ” ìˆœê°„ì€ ìŒì•…ì˜ ì–´ëŠ ë¶€ë¶„ì¸ê°€ìš”?", "ì´ ìŒì•…ì„ ë“¤ìœ¼ë©° '[story]' ì¥ë©´ì„ ìƒìƒí•  ë•Œ, ì–´ë–¤ ë§›ì´ ë‚  ê²ƒ ê°™ë‚˜ìš”?"],
            excited: ["'[story]'ì˜ ì£¼ì¸ê³µì€ ì´ ìŒì•…ì„ ë“£ê³  ì–´ë–¤ ì¶¤ì„ ì¶œê¹Œìš”?", "ì´ ìŒì•…ì˜ ì†ë„ê°€ '[story]'ì˜ ì–´ë–¤ ì›€ì§ì„ì„ í‘œí˜„í–ˆë‚˜ìš”?"],
            sad: ["'[story]'ì˜ ì£¼ì¸ê³µì—ê²Œ ì´ ìŒì•…ì„ ìœ„ë¡œì˜ ì„ ë¬¼ë¡œ ì¤€ë‹¤ë©´, ë­ë¼ê³  ë§í•˜ë©° ì¤„ ê±´ê°€ìš”?", "ì´ ìŒì•…ì˜ ë©œë¡œë””ê°€ ëˆˆë¬¼ë°©ìš¸ì´ë¼ë©´, ì–´ëŠ ë°©í–¥ìœ¼ë¡œ íë¥´ê³  ìˆë‚˜ìš”?"],
            lonely: ["'[story]'ì˜ ì£¼ì¸ê³µì´ í˜¼ì ìˆì„ ë•Œ, ì´ ìŒì•…ì´ ì¹œêµ¬ê°€ ë˜ì–´ì¤„ ìˆ˜ ìˆì„ê¹Œìš”?", "ì´ ìŒì•…ì˜ ì—¬ë°±(ë¹ˆ ê³µê°„)ì€ '[story]'ì˜ ì–´ë–¤ ë§ˆìŒì„ ë‹®ì•˜ë‚˜ìš”?"],
            angry: ["ìŒì•… ì†ì˜ ê°•ë ¬í•œ ë¶€ë¶„ì´ '[story]'ì˜ ì–´ë–¤ ì‚¬ê±´ê³¼ ë‹®ì•˜ë‚˜ìš”?", "ì´ ìŒì•…ì´ ì¾…! í•˜ê³  í„°ì§€ëŠ” í™”ì‚°ì´ë¼ë©´, ê·¸ ì•ˆì— ë¬´ì—‡ì´ ë“¤ì–´ìˆì„ê¹Œìš”?"],
            scary: ["'[story]' ìƒí™©ì—ì„œ ë„ë§ì¹œë‹¤ë©´, ì´ ìŒì•…ì€ ì–¼ë§ˆë‚˜ ë¹ ë¥¸ ì†ë„ë¡œ ì—°ì£¼í•´ì•¼ í• ê¹Œìš”?", "ì´ ìŒì•…ì„ ë“¤ì„ ë•Œ ì‹¬ì¥ì€ ì–´ë–¤ ìƒ‰ê¹”ë¡œ ë›°ê³  ìˆì„ê¹Œìš”?"],
            dream: ["'[story]'ê°€ ê¿ˆì´ë¼ë©´, ì´ ìŒì•…ì€ ê¿ˆì†ì˜ ì–´ë–¤ í’ê²½ì„ ê·¸ë¦¬ê³  ìˆë‚˜ìš”?", "ì´ ìŒì•…ì„ ë“¤ìœ¼ë©´ ì–´ë–¤ ì‹ ë¹„í•œ ë™ë¬¼ì´ ë‚˜íƒ€ë‚  ê²ƒ ê°™ë‚˜ìš”?"],
            proud: ["'[story]'ì˜ ì£¼ì¸ê³µì—ê²Œ ê¸ˆë©”ë‹¬ì„ ê±¸ì–´ì¤€ë‹¤ë©´, ì–´ë–¤ ìŒì•…ì´ ì–´ìš¸ë¦´ê¹Œìš”?", "ì´ ìŒì•…ì˜ ë‹¹ë‹¹í•œ ëŠë‚Œì€ '[story]'ì˜ ë¬´ì—‡ì„ ë‹®ì•˜ë‚˜ìš”?"],
            calm: ["'[story]'ì˜ í‰ì˜¨í•œ ìˆœê°„ì„ ê·¸ë¦¼ìœ¼ë¡œ ê·¸ë¦°ë‹¤ë©´ ì–´ë–¤ ìƒ‰ì„ ì¹ í•˜ê³  ì‹¶ë‚˜ìš”?", "ì´ ìŒì•…ì´ íë¥´ëŠ” ê°•ë¬¼ì´ë¼ë©´, ì–´ë””ë¡œ í˜ëŸ¬ê°€ê³  ìˆë‚˜ìš”?"],
            surprised: ["ìŒì•…ì—ì„œ ê°€ì¥ ê¹œì§ ë†€ë€ ë¶€ë¶„ì€ ì–´ë””ì¸ê°€ìš”? '[story]'ì˜ ë°˜ì „ê³¼ ë‹®ì•˜ë‚˜ìš”?", "ì´ ìŒì•…ì„ ì²˜ìŒ ë“¤ì€ ì‚¬ëŒì˜ í‘œì •ì„ ì§€ì–´ë³´ì„¸ìš”!"]
        };

        const scale = [
            {f:261.63, idx:0, name:'ë„'}, {f:293.66, idx:1, name:'ë ˆ'}, 
            {f:329.63, idx:2, name:'ë¯¸'}, {f:349.23, idx:3, name:'íŒŒ'},
            {f:392.00, idx:4, name:'ì†”'}, {f:440.00, idx:5, name:'ë¼'}, 
            {f:493.88, idx:6, name:'ì‹œ'}, {f:523.25, idx:7, name:'ë„'},
            {f:587.33, idx:8, name:'ë ˆ'}, {f:659.25, idx:9, name:'ë¯¸'}, 
            {f:698.46, idx:10, name:'íŒŒ'}, {f:783.99, idx:11, name:'ì†”'} 
        ];

        const rhythmData = {
            ballad: { beats: 4, loop: [{t:0,i:'kick'},{t:0,i:'chord'},{t:1,i:'snare'},{t:1,i:'chord'},{t:2,i:'kick'},{t:2,i:'chord'},{t:3,i:'snare'},{t:3,i:'chord'}] },
            hiphop: { beats: 4, loop: [{t:0,i:'kick'},{t:0.75,i:'kick'},{t:1,i:'snare'},{t:2,i:'kick'},{t:3,i:'snare'}] },
            march: { beats: 4, loop: [{t:0,i:'kick'},{t:0.5,i:'snare'},{t:1,i:'kick'},{t:1.5,i:'snare'},{t:2,i:'kick'},{t:2.5,i:'snare'},{t:3,i:'kick'},{t:3.5,i:'snare'}] },
            waltz: { beats: 3, loop: [{t:0,i:'kick'},{t:1,i:'snare'},{t:1,i:'chord'},{t:2,i:'snare'},{t:2,i:'chord'}] },
            funk: { beats: 4, loop: [{t:0,i:'kick'}, {t:1,i:'snare'}, {t:1.75,i:'kick'}, {t:2,i:'snare'}, {t:2.5,i:'kick'}, {t:3,i:'snare'}] },
            bossa: { beats: 4, loop: [{t:0,i:'kick'}, {t:0.75,i:'snare'}, {t:2,i:'kick'}, {t:2.75,i:'snare'}] }
        };

        let timeline = [];

        function startApp() {
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('main-timeline').classList.remove('hidden');
            document.getElementById('main-workspace').classList.remove('hidden');
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }

        function setEmotion(btn, emotionName, color) { 
            current.emo = emotionName; current.color = color; 
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected')); 
            btn.classList.add('selected'); updateText(); 
        }

        function switchTab(t) { 
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); 
            document.querySelectorAll('.big-input').forEach(i=>i.classList.add('hidden')); 
            document.getElementById(`input-${t}`).classList.remove('hidden'); document.getElementById(`input-${t}`).focus(); 
        }
        
        function updateText() {
            const when = document.getElementById('input-when').value || 'ì–¸ì œ';
            const rawWhere = document.getElementById('input-where').value || 'ì–´ë”˜ê°€';
            const rawWho = document.getElementById('input-who').value || 'ëˆ„ê°€';
            const what = document.getElementById('input-what').value || 'ë¬´ì—‡ì„ í•˜ê³ ';
            const where = resolveJosa(rawWhere, 'loc'); const who = resolveJosa(rawWho, 'sub');
            current.when=when; current.where=where; current.who=who; current.what=what;
            if(current.emo) { 
                current.text = templates[current.emo].replace('{when}',when).replace('{where}',where).replace('{who}',who).replace('{act}',what); 
                document.getElementById('preview-msg').value = current.text; 
                document.getElementById('preview-msg').style.backgroundColor = current.color; 
            }
        }

        function nextStep(n) { 
            stopDemo(); 
            document.querySelectorAll('section').forEach(s=>s.classList.add('hidden')); 
            document.getElementById(`step-${n}`).classList.remove('hidden'); 
            if(n===3){ renderScoreUI(); renderPiano(); resetMelody(); } 
        }

        function renderScoreUI() {
            const container = document.getElementById('score-container'); container.innerHTML = '';
            for(let i=0; i < current.maxBeats; i++) {
                const box = document.createElement('div'); box.className = 'beat-box'; box.id = `beat-${i}`;
                container.appendChild(box);
            }
            document.getElementById('status-msg').innerText = `${current.maxBeats}ë°•ì ë©œë¡œë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”`;
        }

        function previewRhythm(b,r) { 
            current.rhythm = r; current.maxBeats = rhythmData[r].beats; 
            document.querySelectorAll('.rhythm-card').forEach(c=>c.classList.remove('selected')); b.classList.add('selected'); 
            stopDemo(); playRhythmLoop(r); 
        }

        function stopDemo() { 
            if(activeTimeouts.length > 0) stopAllSound(); 
            document.querySelectorAll('.key').forEach(k=>k.classList.remove('pressed'));
        }

        function playRhythmLoop(r) { 
            if(audioCtx.state==='suspended')audioCtx.resume();
            const d=rhythmData[r]; const bd=0.5;
            const pb=()=>{ const now=audioCtx.currentTime; d.loop.forEach(e=>{ const t=now+e.t*bd; if(e.i==='kick')playKick(t); else if(e.i==='snare')playSnare(t); }); };
            pb(); activeTimeouts.push(setInterval(pb, d.beats * bd * 1000));
        }

        function toggleInstrument(inst) {
            const idx = current.instruments.indexOf(inst);
            if (idx > -1) { if(current.instruments.length > 1) { current.instruments.splice(idx, 1); document.getElementById(`inst-${inst}`).classList.remove('active'); } }
            else { current.instruments.push(inst); document.getElementById(`inst-${inst}`).classList.add('active'); }
        }

        function setNoteLen(mode) {
            current.noteLenMode = mode;
            document.querySelectorAll('.btn-len').forEach(b => b.classList.remove('active'));
            document.getElementById(`len-${mode}`).classList.add('active');
        }

        function cycleRhythm(barIdx) {
            const types = ['repeat', 'quarter', 'eighth', 'swing', 'ending'];
            const labels = {repeat:'ğŸ”„ ê·¸ëŒ€ë¡œ', quarter:'â™© í•œë°•ì', eighth:'â™« ë°˜ë°•ì', swing:'â™ªâ™© ìŠ¤ìœ™', ending:'ğŸ ì¢…ì§€'};
            const idx = barIdx - 2; let currType = current.rhythmVars[idx];
            let nextIdx = (types.indexOf(currType) + 1) % types.length;
            let nextType = types[nextIdx];
            current.rhythmVars[idx] = nextType;
            const btn = document.getElementById(`btn-rvar-${barIdx}`);
            btn.innerText = `${barIdx}. ${labels[nextType]}`;
            btn.setAttribute('data-rtype', nextType);
            previewSingleBar(barIdx);
        }

        function cyclePitch(barIdx) {
            const types = ['same', 'up1', 'up2', 'down1', 'invert', 'end-0', 'end-2', 'end-4', 'end-5', 'end-7'];
            const labels = {same:'â” ê·¸ëŒ€ë¡œ', up1:'ğŸ“ˆ í•œì¹¸ ìœ„', up2:'ğŸš€ ë‘ì¹¸ ìœ„', down1:'ğŸ“‰ í•œì¹¸ ì•„ë˜', invert:'ğŸ”€ ë’¤ì§‘ê¸°', 'end-0':'ğŸ ì¢…ì§€(ë„)', 'end-2':'ğŸ ì¢…ì§€(ë¯¸)', 'end-4':'ğŸ ì¢…ì§€(ì†”)', 'end-5':'ğŸ ì¢…ì§€(ë¼)', 'end-7':'ğŸ ì¢…ì§€(ë†’ì€ë„)'};
            const idx = barIdx - 2; let currType = current.pitchVars[idx];
            let nextIdx = (types.indexOf(currType) + 1) % types.length;
            let nextType = types[nextIdx];
            current.pitchVars[idx] = nextType;
            const btn = document.getElementById(`btn-pvar-${barIdx}`);
            btn.innerText = `${barIdx}. ${labels[nextType]}`;
            btn.setAttribute('data-ptype', nextType);
            previewSingleBar(barIdx);
        }

        function renderPiano() { 
            const b=document.getElementById('piano-area'); b.innerHTML=''; 
            for(let i=0; i<12; i++) {
                let n = scale[i];
                let k=document.createElement('div'); 
                k.className=`key`; 
                k.innerHTML = `<span class="key-label">${n.name}</span>`;
                k.onmousedown=()=> { addNote(n.f,i); k.classList.add('pressed'); };
                k.onmouseup=()=>k.classList.remove('pressed');
                k.onmouseleave=()=>k.classList.remove('pressed');
                b.appendChild(k);

                const hasBlack = [0, 1, 3, 4, 5, 7, 8, 10].includes(i);
                if(hasBlack && i < 11) {
                    let bk = document.createElement('div');
                    bk.className = 'key black';
                    k.appendChild(bk);
                }
            }
        }

        function resolveJosa(word, type) {
            if (!word) return "";
            if (type === 'sub') { const exceptions = ["ë‚´ê°€", "ë„¤ê°€", "ëˆ„ê°€", "ìš°ë¦¬ê°€", "ì €í¬ê°€"]; if (exceptions.includes(word)) return word; }
            if (type === 'loc' && word.endsWith('ì—ì„œ')) return word;
            const last = word.charCodeAt(word.length - 1);
            if (last < 0xAC00 || last > 0xD7A3) return word; 
            const hasBatchim = (last - 0xAC00) % 28 > 0;
            if (type === 'sub') return word + (hasBatchim ? 'ì´' : 'ê°€');
            if (type === 'loc') return word + 'ì—ì„œ';
            return word;
        }

        function stopAllSound() {
            activeNodes.forEach(node => { try { node.stop(); } catch(e) {} try { node.disconnect(); } catch(e) {} });
            activeNodes = [];
            activeTimeouts.forEach(id => { clearTimeout(id); clearInterval(id); });
            activeTimeouts = [];
        }

        function createVibrato(ctx, destination, rate, depth, time) {
             const lfo = ctx.createOscillator(); const lfoGain = ctx.createGain();
             lfo.type = 'sine'; lfo.frequency.value = rate; lfoGain.gain.value = depth;
             lfo.connect(lfoGain); lfoGain.connect(destination.frequency); 
             lfo.start(time); lfo.stop(time + 2); activeNodes.push(lfo);
        }

        function playSound(instType, freq, time, dur) {
            const t = time; const d = dur;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); const filter = audioCtx.createBiquadFilter(); 
            osc.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination); gain.connect(destNode); 
            activeNodes.push(osc); activeNodes.push(gain); 
            let releaseTime = t + d; if (d < 0.3) { releaseTime = t + d + 0.05; } else { releaseTime = t + d + 0.5; } 

            switch(instType) {
                case 'piano':
                    osc.type = 'triangle'; filter.type = 'lowpass'; filter.frequency.setValueAtTime(3000, t);
                    gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.6, t + 0.01); 
                    gain.gain.exponentialRampToValueAtTime(0.01, releaseTime); 
                    const pOsc2 = audioCtx.createOscillator(); const pGain2 = audioCtx.createGain();
                    pOsc2.type = 'sine'; pOsc2.frequency.value = freq * 2; pGain2.gain.value = 0.2;
                    pOsc2.connect(pGain2); pGain2.connect(audioCtx.destination);
                    pOsc2.start(t); pOsc2.stop(releaseTime); activeNodes.push(pOsc2); break;
                case 'violin':
                    osc.type = 'sawtooth'; filter.type = 'lowpass'; filter.frequency.value = 2000; filter.Q.value = 1;
                    gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.3, t + 0.1); 
                    gain.gain.linearRampToValueAtTime(0.2, t + d); gain.gain.linearRampToValueAtTime(0.01, releaseTime);
                    createVibrato(audioCtx, osc, 6, 5, t); break;
                case 'cello':
                    osc.type = 'sawtooth'; filter.type = 'lowpass'; filter.frequency.value = 600; 
                    gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.3, t + 0.15); 
                    gain.gain.linearRampToValueAtTime(0.01, t + d + 0.3);
                    createVibrato(audioCtx, osc, 4, 3, t); break;
                case 'flute':
                    osc.type = 'sine'; filter.type = 'lowpass'; filter.frequency.value = 1500;
                    gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.4, t + 0.05);
                    gain.gain.linearRampToValueAtTime(0.01, releaseTime);
                    createVibrato(audioCtx, osc, 5, 2, t); break;
                case 'bassoon':
                    osc.type = 'square'; filter.type = 'lowpass'; filter.frequency.value = 900; filter.Q.value = 2; 
                    gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.25, t + 0.05);
                    gain.gain.linearRampToValueAtTime(0.01, releaseTime); break;
            }
            osc.frequency.setValueAtTime(freq, t); osc.start(t); osc.stop(releaseTime + 0.1); 
        }

        function playMultiSound(instruments, freq, time, beatDurationSec, totalBeats, accumulatedBeat) {
            const count = instruments.length; const maxBeats = current.maxBeats;
            if (count === 1) { playSound(instruments[0], freq, time, beatDurationSec * totalBeats * 0.9); return; }
            if (count === 2) {
                instruments.forEach(inst => {
                    if (inst === 'piano') {
                        let beatCount = Math.floor(totalBeats);
                        if(beatCount < 1) beatCount = 1;
                        for(let i=0; i<beatCount; i++) {
                             let currentBeatInBar = (accumulatedBeat + i) % maxBeats;
                             if(currentBeatInBar % 2 === 0) { 
                                 let hitTime = time + (i * beatDurationSec);
                                 playSound('piano', freq, hitTime, beatDurationSec * 1.0); 
                                 playSound('piano', freq * 1.5, hitTime, beatDurationSec * 1.0); 
                             }
                        }
                    } else { playSound(inst, freq, time, beatDurationSec * totalBeats * 0.9); }
                });
                return;
            }
            const hasMelodyInst = instruments.includes('flute') || instruments.includes('violin');
            instruments.forEach(inst => {
                if (inst === 'flute' || inst === 'violin') { playSound(inst, freq * 2, time, beatDurationSec * totalBeats * 0.9); } 
                else if (inst === 'cello' || inst === 'bassoon') {
                    if (accumulatedBeat % maxBeats < 0.1) {
                        let bassFreq = freq / 2; if (hasMelodyInst) bassFreq = freq / 4; 
                        playSound(inst, bassFreq, time, beatDurationSec * maxBeats); 
                    }
                } else if (inst === 'piano') {
                    let beatCount = Math.floor(totalBeats);
                    for(let i=0; i<beatCount; i++) {
                         let currentBeatInBar = (accumulatedBeat + i) % maxBeats;
                         if(currentBeatInBar % 2 === 0) { 
                             let hitTime = time + (i * beatDurationSec);
                             playSound('piano', freq, hitTime, beatDurationSec * 1.0); 
                             playSound('piano', freq * 1.5, hitTime, beatDurationSec * 1.0); 
                         }
                    }
                }
            });
        }

        function previewSingleBar(barNum) {
            stopAllSound();
            const tempo = parseFloat(document.getElementById('tempo-slider').value);
            const beatTime = 0.5 / tempo; const now = audioCtx.currentTime;
            let full = getExpandedMelody(current.melody, current.rhythmVars, current.pitchVars);
            let accumulated = 0; let targetStart = (barNum - 1) * current.maxBeats; let targetEnd = targetStart + current.maxBeats;
            let barNotes = [];
            full.forEach(n => { if(accumulated >= targetStart && accumulated < targetEnd) { barNotes.push(n); } accumulated += n.len; });
            let cursor = 0; let localAccum = 0; 
            barNotes.forEach(n => {
                playMultiSound(current.instruments, n.f, now + cursor, beatTime, n.len, localAccum);
                cursor += n.len * beatTime; localAccum += n.len;
            });
        }

        function playWholeStory() {
            stopAllSound();
            if(audioCtx.state==='suspended')audioCtx.resume();
            let accTime=0; const now=audioCtx.currentTime+0.1;
            timeline.forEach((blk, idx) => {
                const tempo = 1.0; const beatTime = 0.5 / blk.tempo;
                const fullMelody = getExpandedMelody(blk.melody, blk.rhythmVars, blk.pitchVars);
                let totalBeats = 0; fullMelody.forEach(n => totalBeats += n.len);
                let totalDur = totalBeats * beatTime;
                const start = now + accTime;
                let to1 = setTimeout(() => { document.querySelectorAll('.story-block').forEach((b,i)=>b.style.background=i===idx?'#ffeaa7':'#f1f2f6'); }, accTime*1000);
                activeTimeouts.push(to1);
                const rData = rhythmData[blk.rhythm]; const loopCount = 4; 
                for(let b=0; b<loopCount; b++) {
                    rData.loop.forEach(evt => {
                        const t = start + (b * current.maxBeats * beatTime) + (evt.t * beatTime); 
                        if(t < start + totalDur) { if(evt.i==='kick') playKick(t); else if(evt.i==='snare') playSnare(t); }
                    });
                }
                let cursor = 0; let accumulatedBeat = 0;
                fullMelody.forEach(n => {
                    let insts = Array.isArray(blk.instruments) ? blk.instruments : [blk.instrument || 'piano'];
                    playMultiSound(insts, n.f, start + cursor, beatTime, n.len, accumulatedBeat);
                    cursor += n.len * beatTime; accumulatedBeat += n.len;
                });
                accTime += totalDur;
            });
            let to2 = setTimeout(() => document.querySelectorAll('.story-block').forEach(b=>b.style.background='#f1f2f6'), accTime*1000);
            activeTimeouts.push(to2);
        }
        
        function previewMelody() {
            stopAllSound();
            const tempo = parseFloat(document.getElementById('tempo-slider').value);
            const beatTime = 0.5 / tempo; const now = audioCtx.currentTime;
            const fullMelody = getExpandedMelody(current.melody, current.rhythmVars, current.pitchVars);
            let cursorTime = 0; let accumulatedBeat = 0;
            fullMelody.forEach((n, i) => {
                playMultiSound(current.instruments, n.f, now + cursorTime, beatTime, n.len, accumulatedBeat);
                cursorTime += n.len * beatTime; accumulatedBeat += n.len;
            });
        }
        
        function addNote(f,i) { 
            stopDemo(); 
            if(audioCtx.state==='suspended')audioCtx.resume();
            let duration = 1.0; 
            if(current.noteLenMode === 'quarter') { duration = 1.0; } 
            else if(current.noteLenMode === 'eighth') { duration = 0.5; } 
            else if(current.noteLenMode === 'swing') {
                let isStart = Math.abs(current.beatIdx % 1) < 0.1;
                if(isStart) { duration = 0.66; } else { duration = 0.34; }
            } else if(current.noteLenMode === 'half') { duration = 2.0; }
            else if(current.noteLenMode === 'dotted') { duration = 3.0; }

            if(current.beatIdx + duration > current.maxBeats + 0.1) { alert("ë°•ìê°€ ë„˜ì¹©ë‹ˆë‹¤!"); return; }

            const tempo = parseFloat(document.getElementById('tempo-slider').value);
            const beatTime = 0.5 / tempo;
            playMultiSound(current.instruments, f, audioCtx.currentTime, beatTime, duration, current.beatIdx);
            current.melody.push({f:f, idx:i, len:duration});
            
            let startBeat = Math.floor(current.beatIdx);
            let endBeat = Math.floor(current.beatIdx + duration - 0.01); 
            const startBox = document.getElementById(`beat-${startBeat}`);
            if(startBox) {
                const subNote = document.createElement('div');
                subNote.className = 'sub-note filled'; subNote.style.height = `${(i+1)*10}%`; subNote.style.width = '100%';
                startBox.appendChild(subNote); startBox.classList.add('active');
            }
            for(let b = startBeat + 1; b <= endBeat; b++) {
                const nextBox = document.getElementById(`beat-${b}`);
                if(nextBox) {
                    const subNote = document.createElement('div');
                    subNote.className = 'sub-note filled'; subNote.style.height = `${(i+1)*10}%`; 
                    subNote.style.width = '100%'; subNote.style.opacity = '0.5'; 
                    nextBox.appendChild(subNote); nextBox.classList.add('active');
                }
            }
            current.beatIdx += duration;
            if(current.beatIdx >= current.maxBeats - 0.1) { 
                document.getElementById('status-msg').innerText="ì™„ì„±! ë³€ì£¼ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”"; 
                document.getElementById('save-controls').classList.remove('hidden'); 
                previewMelody();
            }
        }

        function resetMelody(){ 
            current.melody=[]; current.beatIdx=0;
            const container = document.getElementById('score-container');
            if(container) { renderScoreUI(); }
            document.getElementById('save-controls').classList.add('hidden'); 
            document.getElementById('status-msg').innerText = `${current.maxBeats}ë°•ì ë©œë¡œë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”`;
        }
        function previewIfReady(){ if(current.beatIdx>=3.9) previewMelody(); }

        function getExpandedMelody(baseMelody, rVars, pVars) {
            let expanded = [];
            const getBaseNote = (nIdx) => baseMelody[nIdx % baseMelody.length];
            const applyPitch = (noteObj, pType) => {
                let newIdx = noteObj.idx;
                if(pType === 'up1') newIdx += 1; else if(pType === 'up2') newIdx += 2;
                else if(pType === 'down1') newIdx -= 1; else if(pType === 'invert') newIdx = 7 - noteObj.idx;
                if(pType.startsWith('end-')) { newIdx = parseInt(pType.split('-')[1]); }
                if(newIdx < 0) newIdx = 0; if(newIdx > 11) newIdx = 11;
                return { f: scale[newIdx].f, len: noteObj.len, idx: newIdx };
            };
            baseMelody.forEach(n => expanded.push({f: n.f, len:n.len, idx:n.idx})); 

            for(let i=0; i<3; i++) {
                let rType = rVars[i]; let pType = pVars[i];
                if(rType === 'ending') {
                    let rootFreq = scale[0].f;
                    let endNote = { f: scale[0].f, idx: 0, len: current.maxBeats * 1.0 };
                    let finalNote = applyPitch(endNote, pType);
                    expanded.push(finalNote); continue; 
                }
                let barNotes = [];
                baseMelody.forEach(n => barNotes.push({...n}));
                let shiftedNotes = barNotes.map(n => applyPitch(n, pType));
                shiftedNotes.forEach(n => expanded.push(n));
            }
            return expanded;
        }

        function recordCurrentSegment() {
            current.text = document.getElementById('preview-msg').value; 
            timeline.push(JSON.parse(JSON.stringify(current)));
            let instDisplay = current.instruments.map(i => i === 'piano' ? 'ğŸ¹' : i === 'violin' ? 'ğŸ»' : i === 'cello' ? 'ğŸ»(C)' : i === 'flute' ? 'ğŸŒ¬ï¸' : 'ğŸªµ').join('');
            const d=document.createElement('div'); d.className='story-block'; d.style.borderLeftColor=current.color;
            d.innerHTML=`<div><b>${current.text}</b></div><div><span style="font-size:0.8em; background:#ccc; color:white; padding:3px 8px; border-radius:10px;">${instDisplay} | ${current.rhythm}</span></div>`;
            document.getElementById('timeline-list').appendChild(d); document.getElementById('btn-play-all').classList.remove('hidden');
            document.getElementById('btn-stop-all').classList.remove('hidden');
        }

        function saveAndContinue() {
            recordCurrentSegment(); resetMelody(); stopDemo();
            document.querySelectorAll('section').forEach(s=>s.classList.add('hidden')); 
            document.getElementById('step-1').classList.remove('hidden');
            document.getElementById('input-when').value=''; document.getElementById('input-where').value=''; 
            document.getElementById('input-who').value=''; document.getElementById('input-what').value='';
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.querySelector('.tab-btn').classList.add('active');
            document.querySelectorAll('.big-input').forEach(i=>i.classList.add('hidden')); document.getElementById('input-when').classList.remove('hidden');
        }

        function saveAndFinish() {
            recordCurrentSegment(); stopDemo(); refreshQuestion();
            document.querySelectorAll('section').forEach(s=>s.classList.add('hidden')); 
            document.getElementById('step-4').classList.remove('hidden');
        }

        function playKick(t){ const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.frequency.setValueAtTime(150, t); o.frequency.exponentialRampToValueAtTime(0.01,t+0.5); g.gain.setValueAtTime(1.2, t); g.gain.exponentialRampToValueAtTime(0.01,t+0.5); o.connect(g); g.connect(audioCtx.destination); g.connect(destNode); o.start(t); o.stop(t+0.5); activeNodes.push(o); }
        function playSnare(t){ const b=audioCtx.createBuffer(1,audioCtx.sampleRate*0.1,audioCtx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1; const s=audioCtx.createBufferSource(); s.buffer=b; const g=audioCtx.createGain(); const f=audioCtx.createBiquadFilter(); f.type='highpass'; f.freq=1000; g.gain.setValueAtTime(0.2, t); g.gain.exponentialRampToValueAtTime(0.01,t+0.1); s.connect(f); f.connect(g); g.connect(audioCtx.destination); g.connect(destNode); s.start(t); activeNodes.push(s); }
        function playChord(fs,t,d){ /* Muted */ } 

        // --- STEP 4 FEATURES ---
        function refreshQuestion() {
            // Context-Aware Selection logic
            let pool = inquiryPool[current.emo];
            if(!pool) pool = ["ì´ ìŒì•…ì„ ë“¤ìœ¼ë©´ ì–´ë–¤ ì¥ë©´ì´ ë– ì˜¤ë¥´ë‚˜ìš”?", "ì´ ìŒì•…ì— ì œëª©ì„ ë¶™ì—¬ì£¼ì„¸ìš”."];
            
            const randQ = pool[Math.floor(Math.random() * pool.length)];
            const safeText = current.text ? current.text.replace(/"/g, "'") : "ë‚˜ì˜ ì´ì•¼ê¸°";
            document.getElementById('inquiry-q').innerText = randQ.replace('[story]', safeText);
        }
        function saveText() {
            const txt = `[EAIM ìŒì•… íƒêµ¬ ì¼ì§€]\nì§ˆë¬¸: ${document.getElementById('inquiry-q').innerText}\në‹µë³€: ${document.getElementById('inquiry-a').value}`;
            const blob = new Blob([txt], {type: "text/plain;charset=utf-8"});
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "music_journal.txt"; a.click();
        }
        function downloadAudio() {
            alert("ë…¹ìŒì„ ì‹œì‘í•©ë‹ˆë‹¤... ìŒì•…ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”! ğŸµ");
            const chunks = [];
            const recorder = new MediaRecorder(destNode.stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'my_music.webm'; a.click();
                alert("ë…¹ìŒ ì™„ë£Œ! ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.");
            };
            recorder.start();
            playWholeStory();
            let totalBeats = 0;
            timeline.forEach(b => { totalBeats += (b.maxBeats * 4); });
            setTimeout(() => { recorder.stop(); }, (totalBeats * 500) + 2000); 
        }
    </script>
</body>
</html>
