<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAIM ìŠ¤ë§ˆíŠ¸ ì•™ìƒë¸”</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6C5CE7; --accent: #00B894; --bg: #dfe6e9; --text: #2d3436; --red: #ff7675;
        }
        body {
            font-family: 'Jua', sans-serif; background-color: var(--bg);
            color: var(--text); margin: 0; padding: 20px; text-align: center; user-select: none;
        }
        .hidden { display: none !important; }
        .workspace {
            background: white; padding: 25px; border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); max-width: 700px; margin: 0 auto;
        }
        .step-title { font-size: 1.4em; color: var(--primary); margin-bottom: 15px; }
        .btn-main {
            background: var(--primary); color: white; border: none; padding: 10px 25px;
            border-radius: 30px; font-size: 1.1em; cursor: pointer; font-family: 'Jua'; margin-top: 15px;
            transition: 0.2s;
        }
        .btn-stop {
            background: var(--red); color: white; border: none; padding: 10px 20px;
            border-radius: 30px; font-size: 1.1em; cursor: pointer; font-family: 'Jua'; margin-left: 5px;
        }
        .btn-main:active, .btn-stop:active { transform: scale(0.95); }

        /* íƒ€ì„ë¼ì¸ */
        .timeline-container { background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-height: 100px; }
        .story-block { background: #f1f2f6; border-left: 8px solid #ccc; padding: 15px; margin: 10px 0; text-align: left; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s; }

        /* Step 1 Styles */
        .emotion-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .color-btn { height: 60px; border-radius: 15px; border: 3px solid white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .color-btn.selected { transform: scale(1.1); border-color: #2d3436; font-weight: bold; }
        .color-btn span { font-size: 12px; margin-top: 2px; color: rgba(0,0,0,0.6); }

        .story-tabs { display: flex; justify-content: space-between; background: #f1f2f6; border-radius: 15px; padding: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; border: none; background: transparent; padding: 10px; font-family: 'Jua'; font-size: 1.1em; color: #b2bec3; cursor: pointer; border-radius: 10px; }
        .tab-btn.active { background: white; color: var(--primary); font-weight: bold; }

        .input-area { min-height: 80px; display: flex; align-items: center; justify-content: center; }
        .big-input { width: 80%; padding: 15px; border: 2px solid var(--primary); border-radius: 15px; font-family: 'Jua'; font-size: 1.2em; text-align: center; outline: none; }
        .preview-input { width: 90%; background: #ffeaa7; padding: 15px; border-radius: 15px; margin-top: 20px; color: #2d3436; font-size: 1.2em; text-align: center; border: none; font-family: 'Jua'; }

        /* Step 2 Styles */
        .rhythm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .rhythm-card { border: 2px solid #ddd; border-radius: 15px; padding: 10px; cursor: pointer; background: white; }
        .rhythm-card.selected { border-color: var(--primary); background: #f0f0ff; transform: scale(1.02); }
        .score-svg { width: 100%; height: 50px; margin: 5px 0; }
        .note.active { fill: #e17055; filter: drop-shadow(0 0 5px #e17055); } 
        .rhythm-label { font-size: 1.1em; font-weight: bold; color: var(--primary); }
        .rhythm-desc { font-size: 0.8em; color: #636e72; }

        /* Step 3: Composer UI */
        .composer-console { background: #2d3436; padding: 20px; border-radius: 20px; color: white; }
        
        .score-vis { height: 70px; display: flex; justify-content: center; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #636e72; padding-bottom: 5px; }
        .beat-box { width: 60px; height: 100%; background: rgba(255,255,255,0.1); border-radius: 5px; display: flex; align-items: flex-end; justify-content: center; gap: 2px; padding: 2px; position:relative; overflow: hidden; }
        .beat-box.active { background: rgba(255,255,255,0.2); border: 1px solid var(--accent); }
        .sub-note { background: var(--accent); opacity: 0.3; border-radius: 3px; height: 0; width: 100%; }
        .sub-note.filled { opacity: 1; }

        .controls { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px; text-align: left; }
        .control-label { font-size: 0.9em; color: #dfe6e9; margin-bottom: 5px; margin-top: 10px; }

        .inst-opts { display: flex; justify-content: center; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn-inst { padding: 8px 10px; border-radius: 15px; border: 2px solid #636e72; background: #636e72; color: #b2bec3; font-family: 'Jua'; cursor: pointer; font-size: 0.9em; transition: 0.2s; }
        .btn-inst:hover { background: rgba(255,255,255,0.1); }
        .btn-inst.active { border-color: #fab1a0; background: #fab1a0; color: #2d3436; font-weight: bold; transform: scale(1.05); box-shadow: 0 0 10px #fab1a0; }

        .note-len-opts { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .btn-len { padding: 8px 10px; border-radius: 20px; border: 2px solid #b2bec3; background: transparent; color: #b2bec3; font-family: 'Jua'; cursor: pointer; margin-bottom:5px; }
        .btn-len.active { border-color: var(--accent); color: white; background: var(--accent); font-weight: bold; }

        .train-container { display: flex; gap: 5px; margin-bottom: 5px; }
        .var-car { flex: 1; min-width: 60px; border: 2px solid #b2bec3; border-radius: 8px; padding: 8px 4px; background: transparent; color: #b2bec3; font-family: 'Jua'; cursor: pointer; font-size: 0.85em; transition: 0.2s; white-space: nowrap; }
        .var-car.head { background: #636e72; color: white; border: none; cursor: default; flex: 1.2; text-align: center; }
        .var-car:hover:not(.head) { background: rgba(255,255,255,0.1); }

        .var-car[data-rtype="quarter"] { border-color: #fab1a0; color: #fab1a0; }
        .var-car[data-rtype="eighth"] { border-color: #74b9ff; color: #74b9ff; }
        .var-car[data-rtype="sixteenth"] { border-color: #ff7675; color: #ff7675; }
        .var-car[data-rtype="swing"] { border-color: #a29bfe; color: #a29bfe; }
        .var-car[data-rtype="ending"] { border-color: #00B894; color: #00B894; font-weight:bold; }
        
        .var-car[data-ptype="up1"] { border-color: #fdcb6e; color: #fdcb6e; background: rgba(253, 203, 110, 0.1); }
        .var-car[data-ptype="up2"] { border-color: #e17055; color: #e17055; background: rgba(225, 112, 85, 0.1); font-weight: bold; }
        .var-car[data-ptype="down1"] { border-color: #0984e3; color: #0984e3; background: rgba(9, 132, 227, 0.1); }
        .var-car[data-ptype="invert"] { border-color: #e84393; color: #e84393; background: rgba(232, 67, 147, 0.1); }

        input[type=range] { width: 100%; accent-color: var(--accent); }
        .piano-keys { display: flex; justify-content: center; margin-top: 15px; }
        .key { width: 40px; height: 120px; background: white; margin: 2px; border-radius: 0 0 5px 5px; cursor: pointer; border-bottom: 5px solid #b2bec3; }
        .key.chord { border-top: 8px solid var(--accent); }
        .key:active, .key.pressed { background: #ffeaa7; transform: translateY(2px); border-bottom-width: 2px; }

    </style>
</head>
<body>

    <h1>ğŸ¼ EAIM ìŠ¤ë§ˆíŠ¸ ì•™ìƒë¸”</h1>

    <div class="timeline-container">
        <h3 style="margin:0; color:#b2bec3;">ìš°ë¦¬ì˜ ìŒì•… ì´ì•¼ê¸°</h3>
        <div id="timeline-list"></div>
        <div style="margin-top:10px;">
            <button id="btn-play-all" class="btn-main hidden" style="background:#e17055" onclick="playWholeStory()">â–¶ï¸ ì „ì²´ ê°ìƒ</button>
            <button id="btn-stop-all" class="btn-stop hidden" onclick="stopAllSound()">â–  ì •ì§€</button>
        </div>
    </div>

    <div class="workspace">
        
        <section id="step-1">
            <div class="step-title">Step 1. ê°ì •ê³¼ ì´ì•¼ê¸° ì¡°ê°</div>
            <div class="emotion-grid">
                <div class="color-btn" style="background:#ffeaa7" onclick="setEmotion('happy', '#ffeaa7')">ğŸ˜Š<span>ê¸°ì¨</span></div>
                <div class="color-btn" style="background:#fdcb6e" onclick="setEmotion('excited', '#fdcb6e')">ğŸ‰<span>ì‹ ë‚¨</span></div>
                <div class="color-btn" style="background:#e84393" onclick="setEmotion('surprised', '#e84393')">ğŸ˜²<span>ë†€ëŒ</span></div>
                <div class="color-btn" style="background:#74b9ff" onclick="setEmotion('sad', '#74b9ff')">ğŸ’§<span>ìŠ¬í””</span></div>
                <div class="color-btn" style="background:#dfe6e9" onclick="setEmotion('lonely', '#dfe6e9')">ğŸ‚<span>ì™¸ë¡œì›€</span></div>
                <div class="color-btn" style="background:#ff7675" onclick="setEmotion('angry', '#ff7675')">ğŸ”¥<span>í™”ë‚¨</span></div>
                <div class="color-btn" style="background:#636e72; color:white;" onclick="setEmotion('scary', '#636e72')">ğŸ˜±<span>ë¬´ì„œì›€</span></div>
                <div class="color-btn" style="background:#a29bfe" onclick="setEmotion('dream', '#a29bfe')">ğŸ”®<span>ì‹ ë¹„</span></div>
                <div class="color-btn" style="background:#00b894" onclick="setEmotion('proud', '#00b894')">ğŸ†<span>ë¿Œë“¯</span></div>
                <div class="color-btn" style="background:#55efc4" onclick="setEmotion('calm', '#55efc4')">ğŸŒ¿<span>í‰ì˜¨</span></div>
            </div>
            <div class="story-tabs">
                <button class="tab-btn active" onclick="switchTab('when')">ğŸ•’ ì–¸ì œ</button>
                <button class="tab-btn" onclick="switchTab('where')">ğŸ“ ì–´ë””ì„œ</button>
                <button class="tab-btn" onclick="switchTab('who')">ğŸ‘¤ ëˆ„ê°€</button>
                <button class="tab-btn" onclick="switchTab('what')">ğŸˆ ë¬´ì—‡ì„</button>
            </div>
            <div class="input-area">
                <input type="text" id="input-when" class="big-input" placeholder="ì˜ˆ: ì–´ëŠ ë§‘ì€ ì•„ì¹¨" oninput="updateText()">
                <input type="text" id="input-where" class="big-input hidden" placeholder="ì˜ˆ: ë¬´ì§€ê°œ ë™ì‚° (ë‹¨ì–´ë§Œ)" oninput="updateText()">
                <input type="text" id="input-who" class="big-input hidden" placeholder="ì˜ˆ: ì¹œêµ¬ì™€ (ììœ ë¡­ê²Œ)" oninput="updateText()">
                <input type="text" id="input-what" class="big-input hidden" placeholder="ì˜ˆ: ì¶¤ì„ ì·„ì–´ (ì„œìˆ ì–´)" oninput="updateText()">
            </div>
            <input type="text" id="preview-msg" class="preview-input" value="(ê°ì •ì„ ì„ íƒí•˜ë©´ ì´ì•¼ê¸°ê°€ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤)" placeholder="ë‚´ìš©ì„ ììœ ë¡­ê²Œ ìˆ˜ì •í•´ë³´ì„¸ìš”!">
            <button class="btn-main" onclick="nextStep(2)">ì´ì•¼ê¸° ì™„ì„±! ë¦¬ë“¬ ì •í•˜ê¸° ğŸ‘‰</button>
        </section>

        <section id="step-2" class="hidden">
            <div class="step-title">Step 2. ë¦¬ë“¬ì„ ë“£ê³  ê³¨ë¼ë³´ì„¸ìš”</div>
            <div class="rhythm-grid">
                <div class="rhythm-card" onclick="previewRhythm(this, 'ballad')"><div class="rhythm-label">â˜ï¸ ë°œë¼ë“œ</div><svg class="score-svg" viewBox="0 0 200 60"><line x1="0" y1="30" x2="200" y2="30" stroke="#999" stroke-width="2"/><g class="note bal-0"><circle cx="25" cy="30" r="6"/><line x1="31" y1="30" x2="31" y2="10" stroke="black" stroke-width="2"/></g><g class="note bal-1"><circle cx="75" cy="30" r="6"/><line x1="81" y1="30" x2="81" y2="10" stroke="black" stroke-width="2"/></g><g class="note bal-2"><circle cx="125" cy="30" r="6"/><line x1="131" y1="30" x2="131" y2="10" stroke="black" stroke-width="2"/></g><g class="note bal-3"><circle cx="175" cy="30" r="6"/><line x1="181" y1="30" x2="181" y2="10" stroke="black" stroke-width="2"/></g></svg><div class="rhythm-desc">ë¶€ë“œëŸ¬ìš´ í”¼ì•„ë…¸</div></div>
                <div class="rhythm-card" onclick="previewRhythm(this, 'hiphop')"><div class="rhythm-label">ğŸ€ í™í•©</div><svg class="score-svg" viewBox="0 0 200 60"><line x1="0" y1="30" x2="200" y2="30" stroke="#999" stroke-width="2"/><g class="note hip-0"><circle cx="20" cy="30" r="6"/><line x1="26" y1="30" x2="26" y2="10" stroke="black" stroke-width="2"/><g class="note hip-1"><circle cx="70" cy="30" r="6"/><line x1="76" y1="30" x2="76" y2="10" stroke="black" stroke-width="2"/><g class="note hip-2"><circle cx="110" cy="30" r="6"/><line x1="116" y1="30" x2="116" y2="10" stroke="black" stroke-width="2"/><line x1="116" y1="10" x2="126" y2="15" stroke="black" stroke-width="2"/></g><g class="note hip-3"><circle cx="170" cy="30" r="6"/><line x1="176" y1="30" x2="176" y2="10" stroke="black" stroke-width="2"/></g></svg><div class="rhythm-desc">ì¿µ-ì§-ì§ ë¹„íŠ¸</div></div>
                <div class="rhythm-card" onclick="previewRhythm(this, 'march')"><div class="rhythm-label">ğŸ‘Ÿ í–‰ì§„</div><svg class="score-svg" viewBox="0 0 200 60"><line x1="0" y1="30" x2="200" y2="30" stroke="#999" stroke-width="2"/><g class="note mar-0"><circle cx="20" cy="30" r="5"/><circle cx="40" cy="30" r="5"/><polyline points="26,30 26,10 46,10 46,30" fill="none" stroke="black" stroke-width="2"/><rect x="26" y="10" width="20" height="5" fill="black"/></g><g class="note mar-1"><circle cx="70" cy="30" r="5"/><circle cx="90" cy="30" r="5"/><polyline points="76,30 76,10 96,10 96,30" fill="none" stroke="black" stroke-width="2"/><rect x="76" y="10" width="20" height="5" fill="black"/></g><g class="note mar-2"><circle cx="120" cy="30" r="5"/><circle cx="140" cy="30" r="5"/><polyline points="126,30 126,10 146,10 146,30" fill="none" stroke="black" stroke-width="2"/><rect x="126" y="10" width="20" height="5" fill="black"/></g></svg><div class="rhythm-desc">ì”©ì”©í•œ ë“œëŸ¼</div></div>
                <div class="rhythm-card" onclick="previewRhythm(this, 'waltz')"><div class="rhythm-label">ğŸ’ƒ ì™ˆì¸ </div><svg class="score-svg" viewBox="0 0 200 60"><line x1="0" y1="30" x2="200" y2="30" stroke="#999" stroke-width="2"/><text x="5" y="25" font-size="12" fill="#666">3/4</text><g class="note wal-0"><circle cx="50" cy="30" r="6"/><line x1="56" y1="30" x2="56" y2="10" stroke="black" stroke-width="2"/><g class="note wal-1"><circle cx="100" cy="30" r="6"/><line x1="106" y1="30" x2="106" y2="10" stroke="black" stroke-width="2"/></g><g class="note wal-2"><circle cx="150" cy="30" r="6"/><line x1="156" y1="30" x2="156" y2="10" stroke="black" stroke-width="2"/></g></svg><div class="rhythm-desc">3ë°•ì ì¿µì§ì§</div></div>
                <div class="rhythm-card" onclick="previewRhythm(this, 'funk')"><div class="rhythm-label">ğŸ¸ í‘í¬</div><svg class="score-svg" viewBox="0 0 200 60"><line x1="0" y1="30" x2="200" y2="30" stroke="#999" stroke-width="2"/><g class="note fnk-0"><circle cx="20" cy="30" r="6"/><line x1="26" y1="30" x2="26" y2="10" stroke="black" stroke-width="2"/><g class="note fnk-1"><circle cx="70" cy="30" r="6"/><line x1="76" y1="30" x2="76" y2="10" stroke="black" stroke-width="2"/><g class="note fnk-2"><circle cx="90" cy="30" r="6"/><line x1="96" y1="30" x2="96" y2="10" stroke="black" stroke-width="2"/><g class="note fnk-3"><circle cx="170" cy="30" r="6"/><line x1="176" y1="30" x2="176" y2="10" stroke="black" stroke-width="2"/></g></svg><div class="rhythm-desc">ìª¼ê°œì§€ëŠ” 16ë¹„íŠ¸</div></div>
                <div class="rhythm-card" onclick="previewRhythm(this, 'bossa')"><div class="rhythm-label">ğŸ–ï¸ ë³´ì‚¬ë…¸ë°”</div><svg class="score-svg" viewBox="0 0 200 60"><line x1="0" y1="30" x2="200" y2="30" stroke="#999" stroke-width="2"/><g class="note bos-0"><circle cx="20" cy="30" r="6"/><line x1="26" y1="30" x2="26" y2="10" stroke="black" stroke-width="2"/><g class="note bos-1"><circle cx="60" cy="30" r="6"/><line x1="66" y1="30" x2="66" y2="10" stroke="black" stroke-width="2"/><g class="note bos-2"><circle cx="120" cy="30" r="6"/><line x1="126" y1="30" x2="126" y2="10" stroke="black" stroke-width="2"/></g><g class="note bos-3"><circle cx="160" cy="30" r="6"/><line x1="166" y1="30" x2="166" y2="10" stroke="black" stroke-width="2"/></g></svg><div class="rhythm-desc">ë¼í‹´ ì‹±ì½”í˜ì´ì…˜</div></div>
            </div>
            <button class="btn-main" onclick="nextStep(3)">ì´ ë¦¬ë“¬ìœ¼ë¡œ ê²°ì •! ğŸ‘‰</button>
        </section>

        <section id="step-3" class="hidden">
            <div class="step-title">Step 3. ì‘ê³¡ & ë³€ì£¼ (í•©ì£¼ + ë¦¬ë“¬ + ë©œë¡œë””)</div>
            <div class="composer-console">
                <div class="control-label">ğŸ» ì•…ê¸° í•©ì£¼ ì„ íƒ (ì›í•˜ëŠ” ë§Œí¼ ëˆ„ë¥´ì„¸ìš”!)</div>
                <div class="inst-opts">
                    <button class="btn-inst active" id="inst-piano" onclick="toggleInstrument('piano')">ğŸ¹ í”¼ì•„ë…¸</button>
                    <button class="btn-inst" id="inst-violin" onclick="toggleInstrument('violin')">ğŸ» ë°”ì´ì˜¬ë¦°</button>
                    <button class="btn-inst" id="inst-cello" onclick="toggleInstrument('cello')">ğŸ» ì²¼ë¡œ</button>
                    <button class="btn-inst" id="inst-flute" onclick="toggleInstrument('flute')">ğŸŒ¬ï¸ í”Œë£¨íŠ¸</button>
                    <button class="btn-inst" id="inst-bassoon" onclick="toggleInstrument('bassoon')">ğŸªµ ë°”ìˆœ</button>
                </div>

                <div class="note-len-opts">
                    <button class="btn-len" id="len-eighth" onclick="setNoteLen('eighth')">â™« ë°˜ë°•ì</button>
                    <button class="btn-len active" id="len-quarter" onclick="setNoteLen('quarter')">â™© í•œë°•ì</button>
                    <button class="btn-len" id="len-swing" onclick="setNoteLen('swing')">â™ªâ™© ìŠ¤ìœ™</button>
                    <button class="btn-len" id="len-half" onclick="setNoteLen('half')">ğ… ë‘ë°•ì</button>
                    <button class="btn-len" id="len-dotted" onclick="setNoteLen('dotted')">ğ…. ì„¸ë°•ì</button>
                </div>

                <div class="score-vis">
                    <div id="beat-0" class="beat-box"></div>
                    <div id="beat-1" class="beat-box"></div>
                    <div id="beat-2" class="beat-box"></div>
                    <div id="beat-3" class="beat-box"></div>
                </div>
                
                <div class="controls">
                    <div class="control-label">ğŸš‚ ë¦¬ë“¬(Rhythm) ë³€ì£¼</div>
                    <div class="train-container">
                        <button class="var-car head">1.ë‚˜ì˜ ë©œë¡œë””</button>
                        <button class="var-car" id="btn-rvar-2" data-rtype="repeat" onclick="cycleRhythm(2)">2. ğŸ”„ ê·¸ëŒ€ë¡œ</button>
                        <button class="var-car" id="btn-rvar-3" data-rtype="repeat" onclick="cycleRhythm(3)">3. ğŸ”„ ê·¸ëŒ€ë¡œ</button>
                        <button class="var-car" id="btn-rvar-4" data-rtype="repeat" onclick="cycleRhythm(4)">4. ğŸ”„ ê·¸ëŒ€ë¡œ</button>
                    </div>

                    <div class="control-label">ğŸ¢ ë©œë¡œë””(Melody) ë³€ì£¼</div>
                    <div class="train-container">
                        <button class="var-car head" style="background:#2d3436; border:1px solid #636e72;">ìŒë†’ì´</button>
                        <button class="var-car" id="btn-pvar-2" data-ptype="same" onclick="cyclePitch(2)">2. â” ê·¸ëŒ€ë¡œ</button>
                        <button class="var-car" id="btn-pvar-3" data-ptype="same" onclick="cyclePitch(3)">3. â” ê·¸ëŒ€ë¡œ</button>
                        <button class="var-car" id="btn-pvar-4" data-ptype="same" onclick="cyclePitch(4)">4. â” ê·¸ëŒ€ë¡œ</button>
                    </div>
                    
                    <div style="display:flex; justify-content: space-between; margin-top:15px; align-items:center;">
                        <div style="width:48%">
                            <label>ğŸ¢ ë¹ ë¥´ê¸° ğŸ‡</label>
                            <input type="range" id="tempo-slider" min="0.5" max="2.0" step="0.1" value="1.0" oninput="previewIfReady()">
                        </div>
                        <div style="width:48%; display:flex; gap:5px;">
                            <button class="btn-main" style="padding:5px 10px; margin:0; font-size:0.9em; flex:1; background:#00B894;" onclick="previewMelody()">ğŸ”Š ì „ì²´ ë“£ê¸°</button>
                            <button class="btn-stop" style="padding:5px 10px; margin:0; font-size:0.9em; flex:0.5;" onclick="stopAllSound()">â– </button>
                        </div>
                    </div>
                </div>

                <div class="piano-keys" id="piano-area"></div>
                <div id="status-msg" style="margin-top:10px;">1ë§ˆë”” ë©œë¡œë””ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì´ 4ë°•ì)</div>
            </div>
            <button id="btn-save" class="btn-main hidden" onclick="saveBlock()">ğŸ“¥ ì €ì¥í•˜ê¸°</button>
            <button class="btn-main" style="background:#636e72; font-size:0.9em; margin-top:10px;" onclick="resetMelody()">ğŸ”„ ë‹¤ì‹œ ì“°ê¸°</button>
        </section>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let activeNodes = [];
        let activeTimeouts = [];

        function stopAllSound() {
            activeNodes.forEach(node => {
                try { node.stop(); } catch(e) {}
                try { node.disconnect(); } catch(e) {}
            });
            activeNodes = [];
            activeTimeouts.forEach(id => clearTimeout(id));
            activeTimeouts = [];
        }
        
        function resolveJosa(word, type) {
            if (!word) return "";
            if (type === 'sub') {
                const exceptions = ["ë‚´ê°€", "ë„¤ê°€", "ëˆ„ê°€", "ìš°ë¦¬ê°€", "ì €í¬ê°€"];
                if (exceptions.includes(word)) return word; 
            }
            if (type === 'loc' && word.endsWith('ì—ì„œ')) return word;
            const last = word.charCodeAt(word.length - 1);
            if (last < 0xAC00 || last > 0xD7A3) return word; 
            const hasBatchim = (last - 0xAC00) % 28 > 0;
            if (type === 'sub') return word + (hasBatchim ? 'ì´' : 'ê°€');
            if (type === 'loc') return word + 'ì—ì„œ';
            return word;
        }

        // Sound Engine
        function createVibrato(ctx, destination, rate = 5, depth = 10, time) {
            const lfo = ctx.createOscillator();
            const lfoGain = ctx.createGain();
            lfo.type = 'sine';
            lfo.frequency.value = rate;
            lfoGain.gain.value = depth;
            lfo.connect(lfoGain);
            lfoGain.connect(destination.frequency); 
            lfo.start(time);
            lfo.stop(time + 2); 
            activeNodes.push(lfo);
        }

        function playSound(instType, freq, time, dur) {
            const t = time;
            const d = dur;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter(); 

            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            activeNodes.push(osc);
            activeNodes.push(gain); 

            switch(instType) {
                case 'piano':
                    osc.type = 'triangle';
                    filter.type = 'lowpass'; filter.frequency.setValueAtTime(3000, t);
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.6, t + 0.01); 
                    gain.gain.exponentialRampToValueAtTime(0.01, t + d + 0.5); 
                    
                    const pOsc2 = audioCtx.createOscillator();
                    const pGain2 = audioCtx.createGain();
                    pOsc2.type = 'sine'; pOsc2.frequency.value = freq * 2; 
                    pGain2.gain.value = 0.2;
                    pOsc2.connect(pGain2); pGain2.connect(audioCtx.destination);
                    pOsc2.start(t); pOsc2.stop(t+d+0.5);
                    activeNodes.push(pOsc2);
                    break;

                case 'violin':
                    osc.type = 'sawtooth';
                    filter.type = 'lowpass'; filter.frequency.value = 2000; filter.Q.value = 1;
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.3, t + 0.1); 
                    gain.gain.linearRampToValueAtTime(0.2, t + d); 
                    gain.gain.linearRampToValueAtTime(0.01, t + d + 0.2);
                    createVibrato(audioCtx, osc, 6, 5, t);
                    break;

                case 'cello':
                    osc.type = 'sawtooth';
                    filter.type = 'lowpass'; filter.frequency.value = 600; 
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.3, t + 0.15); 
                    gain.gain.linearRampToValueAtTime(0.01, t + d + 0.3);
                    createVibrato(audioCtx, osc, 4, 3, t);
                    break;

                case 'flute':
                    osc.type = 'sine';
                    filter.type = 'lowpass'; filter.frequency.value = 1500;
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.4, t + 0.05);
                    gain.gain.linearRampToValueAtTime(0.01, t + d + 0.1);
                    createVibrato(audioCtx, osc, 5, 2, t); 
                    break;

                case 'bassoon':
                    osc.type = 'square';
                    filter.type = 'lowpass'; filter.frequency.value = 900; filter.Q.value = 2; 
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.25, t + 0.05);
                    gain.gain.linearRampToValueAtTime(0.01, t + d + 0.1);
                    break;
            }

            osc.frequency.setValueAtTime(freq, t);
            osc.start(t);
            osc.stop(t + d + 1.0); 
        }

        // --- SMART & CLEAN ENSEMBLE LOGIC ---
        function playMultiSound(instruments, freq, time, dur, accumulatedBeat) {
            if(instruments.length === 0) { playSound('piano', freq, time, dur); return; }

            const hasMelodyInst = instruments.includes('flute') || instruments.includes('violin');
            const hasBassInst = instruments.includes('cello') || instruments.includes('bassoon');
            const hasPiano = instruments.includes('piano');

            instruments.forEach(inst => {
                // 1. MELODY GROUP
                if (inst === 'flute' || inst === 'violin') {
                    playSound(inst, freq, time, dur);
                } 
                // 2. BASS GROUP (Only Downbeat)
                else if (inst === 'cello' || inst === 'bassoon') {
                    // Only on Beat 0 of the measure
                    if (accumulatedBeat % 4.0 < 0.1) {
                        let bassFreq = freq / 2;
                        if(hasMelodyInst || hasPiano) bassFreq = freq / 4; 
                        playSound(inst, bassFreq, time, 4.0); // Sustain for whole measure
                    }
                } 
                // 3. PIANO (Smart Filling)
                else if (inst === 'piano') {
                    if (hasMelodyInst && hasBassInst) {
                        // TRIO MODE: Don't clash with Bass. Play mid-range chords lightly on beats.
                        // Play quarter notes on the beat to keep rhythm
                        playSound('piano', freq, time, 0.2); 
                        playSound('piano', freq * 1.5, time, 0.2); 
                    } 
                    else if (hasMelodyInst) {
                        // DUET (Violin+Piano): Piano plays Bass + Harmony (Half notes)
                        let relBeat = accumulatedBeat % 4.0;
                        if (relBeat < 0.1 || Math.abs(relBeat - 2.0) < 0.1) {
                            playSound('piano', freq / 2, time, 2.0); 
                            playSound('piano', freq * 1.5 / 2, time, 2.0); 
                        }
                    } 
                    else {
                        // SOLO MODE: Melody + Harmony
                        playSound('piano', freq, time, dur); 
                        playSound('piano', freq / 2, time, dur); 
                    }
                }
            });
        }

        function playKick(t){ 
            const o=audioCtx.createOscillator(),g=audioCtx.createGain(); 
            o.frequency.setValueAtTime(150, t); o.frequency.exponentialRampToValueAtTime(0.01,t+0.5); 
            g.gain.setValueAtTime(1.5, t); g.gain.exponentialRampToValueAtTime(0.01,t+0.5); 
            o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.5); activeNodes.push(o);
        }
        function playSnare(t){ 
            const b=audioCtx.createBuffer(1,audioCtx.sampleRate*0.1,audioCtx.sampleRate); 
            const d=b.getChannelData(0); for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1; 
            const s=audioCtx.createBufferSource(); s.buffer=b; const g=audioCtx.createGain(); 
            const f=audioCtx.createBiquadFilter(); f.type='highpass'; f.freq=1000; 
            g.gain.setValueAtTime(1.2, t); g.gain.exponentialRampToValueAtTime(0.01,t+0.1); 
            s.connect(f); f.connect(g); g.connect(audioCtx.destination); s.start(t); activeNodes.push(s);
        }
        function playChord(fs,t,d){ fs.forEach(f=>playSound('piano',f,t,d)); } 

        const C_CHORD = [261.6, 329.6, 392.0];
        const rhythmData = {
            ballad: { loop: [{t:0,i:'kick'},{t:0,i:'chord'},{t:1,i:'snare'},{t:1,i:'chord'},{t:2,i:'kick'},{t:2,i:'chord'},{t:3,i:'snare'},{t:3,i:'chord'}], notes: ['bal-0','bal-1','bal-2','bal-3'] },
            hiphop: { loop: [{t:0,i:'kick'},{t:0.75,i:'kick'},{t:1,i:'snare'},{t:2,i:'kick'},{t:3,i:'snare'}], notes: ['hip-0','hip-1','hip-2','hip-3'] },
            march: { loop: [{t:0,i:'kick'},{t:0.5,i:'snare'},{t:1,i:'kick'},{t:1.5,i:'snare'},{t:2,i:'kick'},{t:2.5,i:'snare'},{t:3,i:'kick'},{t:3.5,i:'snare'}], notes: ['mar-0','mar-0','mar-1','mar-1'] },
            waltz: { loop: [{t:0,i:'kick'},{t:1,i:'snare'},{t:1,i:'chord'},{t:2,i:'snare'},{t:2,i:'chord'}], notes: ['wal-0','wal-1','wal-2'] },
            funk: { loop: [{t:0,i:'kick'}, {t:1,i:'snare'}, {t:1.75,i:'kick'}, {t:2,i:'snare'}, {t:2.5,i:'kick'}, {t:3,i:'snare'}], notes: ['fnk-0','fnk-1','fnk-2','fnk-3'] },
            bossa: { loop: [{t:0,i:'kick'}, {t:0.75,i:'snare'}, {t:2,i:'kick'}, {t:2.75,i:'snare'}], notes: ['bos-0','bos-1','bos-2','bos-3'] }
        };
        const scale = [
            {f:261.63, t:'chord', idx:0}, {f:293.66, t:'pass', idx:1}, {f:329.63, t:'chord', idx:2}, {f:349.23, t:'pass', idx:3},
            {f:392.00, t:'chord', idx:4}, {f:440.00, t:'pass', idx:5}, {f:493.88, t:'pass', idx:6}, {f:523.25, t:'chord', idx:7},
            {f:587.33, t:'pass', idx:8}, {f:659.25, t:'chord', idx:9}, {f:698.46, t:'pass', idx:10}, {f:783.99, t:'chord', idx:11} 
        ];
        const templates = {
            happy: "{when} {where} {who} ê¸°ë¶„ ì¢‹ê²Œ {act} ğŸ˜Š", excited: "{when} {where} {who} ì‹ ë‚˜ê²Œ {act} ğŸ‰", sad: "{when} {where} {who} ìŠ¬í”„ê²Œ {act} ğŸ’§",
            lonely: "{when} {where} {who} í˜¼ì ì™¸ë¡­ê²Œ {act} ğŸ‚", angry: "{when} {where} {who} í™”ê°€ ë‚˜ì„œ {act} ğŸ”¥", scary: "{when} ê¹œê¹œí•œ {where} {who} ë¬´ì„­ê²Œ {act} ğŸ˜±",
            dream: "{when} ê¿ˆì† {where} {who} ì‹ ë¹„ë¡­ê²Œ {act} ğŸ”®", proud: "{when} {where} {who} ìë‘ìŠ¤ëŸ½ê²Œ {act} ğŸ†", calm: "{when} {where} {who} í‰ì˜¨í•˜ê²Œ {act} ğŸŒ¿",
            surprised: "{when} {where} {who} ê¹œì§ ë†€ë¼ {act} ğŸ˜²"
        };

        let current = { emo:'', rhythm:'', instruments:['piano'], melody:[], tempo:1.0, artic:'long', text:'', rhythmVars:['repeat','repeat','repeat'], pitchVars:['same','same','same'], noteLenMode:'quarter', beatIdx:0, when:'', where:'', who:'', what:'' };
        let demoTimer = null;
        let timeline = [];

        function setEmotion(e,c) { current.emo=e; current.color=c; document.querySelectorAll('.color-btn').forEach(b=>b.classList.remove('selected')); event.target.classList.add('selected'); updateText(); }
        function switchTab(t) { document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); document.querySelectorAll('.big-input').forEach(i=>i.classList.add('hidden')); document.getElementById(`input-${t}`).classList.remove('hidden'); document.getElementById(`input-${t}`).focus(); }
        
        function updateText() {
            const when = document.getElementById('input-when').value || 'ì–¸ì œ';
            const rawWhere = document.getElementById('input-where').value || 'ì–´ë”˜ê°€';
            const rawWho = document.getElementById('input-who').value || 'ëˆ„ê°€';
            const what = document.getElementById('input-what').value || 'ë¬´ì—‡ì„ í•˜ê³ ';
            
            const where = resolveJosa(rawWhere, 'loc');
            const who = resolveJosa(rawWho, 'sub');

            current.when=when; current.where=where; current.who=who; current.what=what;
            
            if(current.emo) { 
                current.text = templates[current.emo].replace('{when}',when).replace('{where}',where).replace('{who}',who).replace('{act}',what); 
                document.getElementById('preview-msg').value = current.text; 
                document.getElementById('preview-msg').style.backgroundColor = current.color; 
            }
        }

        function nextStep(n) { 
            if(n===2&&!current.emo)return alert("ê°ì • ì„ íƒ!"); 
            if(n===3&&!current.rhythm)return alert("ë¦¬ë“¬ ì„ íƒ!"); 
            stopDemo(); 
            document.querySelectorAll('section').forEach(s=>s.classList.add('hidden')); 
            document.getElementById(`step-${n}`).classList.remove('hidden'); 
            if(n===3){ renderPiano(); resetMelody(); } 
        }
        function previewRhythm(b,r) { current.rhythm=r; document.querySelectorAll('.rhythm-card').forEach(c=>c.classList.remove('selected')); b.classList.add('selected'); stopDemo(); playRhythmLoop(r); }
        function stopDemo() { if(demoTimer)clearInterval(demoTimer); document.querySelectorAll('.note').forEach(n=>n.classList.remove('active')); stopAllSound(); }
        function playRhythmLoop(r) { 
            if(audioCtx.state==='suspended')audioCtx.resume();
            const d=rhythmData[r]; const bd=0.5;
            const pb=()=>{ const now=audioCtx.currentTime; d.loop.forEach(e=>{ const t=now+e.t*bd; if(e.i==='kick')playKick(t); else if(e.i==='snare')playSnare(t); else playChord(C_CHORD,t,0.3); }); d.notes.forEach((c,i)=>{ setTimeout(()=>{ document.querySelectorAll('.'+c).forEach(n=>n.classList.add('active')); setTimeout(()=>document.querySelectorAll('.'+c).forEach(n=>n.classList.remove('active')),300); }, i*bd*1000); }); };
            pb(); demoTimer=setInterval(pb,(r==='waltz'?3:4)*bd*1000);
        }
        
        function toggleInstrument(inst) {
            const idx = current.instruments.indexOf(inst);
            if (idx > -1) {
                if(current.instruments.length > 1) {
                    current.instruments.splice(idx, 1);
                    document.getElementById(`inst-${inst}`).classList.remove('active');
                }
            } else {
                current.instruments.push(inst);
                document.getElementById(`inst-${inst}`).classList.add('active');
            }
        }

        function cycleRhythm(barIdx) {
            const types = ['repeat', 'quarter', 'eighth', 'sixteenth', 'swing', 'ending'];
            const labels = {repeat:'ğŸ”„ ê·¸ëŒ€ë¡œ', quarter:'â™© í•œë°•ì', eighth:'â™« ë°˜ë°•ì', sixteenth:'â™¬ 16ë¶„ìŒí‘œ', swing:'â™ªâ™© ìŠ¤ìœ™', ending:'ğŸ ì¢…ì§€'};
            const idx = barIdx - 2; let currType = current.rhythmVars[idx];
            let nextIdx = (types.indexOf(currType) + 1) % types.length;
            let nextType = types[nextIdx];
            current.rhythmVars[idx] = nextType;
            const btn = document.getElementById(`btn-rvar-${barIdx}`);
            btn.innerText = `${barIdx}. ${labels[nextType]}`;
            btn.setAttribute('data-rtype', nextType);
            previewSingleBar(barIdx);
        }

        function cyclePitch(barIdx) {
            const types = ['same', 'up1', 'up2', 'down1', 'invert'];
            const labels = {same:'â” ê·¸ëŒ€ë¡œ', up1:'ğŸ“ˆ í•œì¹¸ ìœ„', up2:'ğŸš€ ë‘ì¹¸ ìœ„', down1:'ğŸ“‰ í•œì¹¸ ì•„ë˜', invert:'ğŸ”€ ë’¤ì§‘ê¸°'};
            const idx = barIdx - 2; let currType = current.pitchVars[idx];
            let nextIdx = (types.indexOf(currType) + 1) % types.length;
            let nextType = types[nextIdx];
            current.pitchVars[idx] = nextType;
            const btn = document.getElementById(`btn-pvar-${barIdx}`);
            btn.innerText = `${barIdx}. ${labels[nextType]}`;
            btn.setAttribute('data-ptype', nextType);
            previewSingleBar(barIdx);
        }

        function setNoteLen(mode) {
            current.noteLenMode = mode;
            document.querySelectorAll('.btn-len').forEach(b => b.classList.remove('active'));
            document.getElementById(`len-${mode}`).classList.add('active');
        }

        function renderPiano() { 
            const b=document.getElementById('piano-area'); b.innerHTML=''; 
            for(let i=0; i<8; i++) {
                let n = scale[i];
                let k=document.createElement('div'); k.className=`key ${n.t}`; 
                k.onmousedown=()=> { addNote(n.f,i); k.classList.add('pressed'); };
                k.onmouseup=()=>k.classList.remove('pressed');
                k.onmouseleave=()=>k.classList.remove('pressed');
                b.appendChild(k);
            }
        }
        
        function addNote(f,i) { 
            stopDemo(); 
            if(audioCtx.state==='suspended')audioCtx.resume();
            
            let duration = 1.0; 
            let visualWidth = '100%';
            
            if(current.noteLenMode === 'quarter') { duration = 1.0; } 
            else if(current.noteLenMode === 'eighth') { duration = 0.5; visualWidth = '48%'; } 
            else if(current.noteLenMode === 'swing') {
                let isStart = Math.abs(current.beatIdx % 1) < 0.1;
                if(isStart) { duration = 0.66; visualWidth = '60%'; }
                else { duration = 0.34; visualWidth = '35%'; }
            } else if(current.noteLenMode === 'half') { duration = 2.0; visualWidth = '100%'; }
            else if(current.noteLenMode === 'dotted') { duration = 3.0; visualWidth = '100%'; }

            // *** 4ë°•ì ì²´í¬ (ì†Œìˆ˜ì  ì˜¤ì°¨ í—ˆìš©) ***
            if(current.beatIdx + duration > 4.01) {
                alert(`ì•—! ${4 - current.beatIdx}ë°•ìë°–ì— ì•ˆ ë‚¨ì•˜ëŠ”ë°, ${duration}ë°•ìë¥¼ ë„£ìœ¼ë ¤ í•˜ì‹œë„¤ìš”!`);
                return;
            }

            // Preview Note
            playMultiSound(current.instruments, f, audioCtx.currentTime, 0.4 * duration, (current.beatIdx % 4.0 < 0.1)); 
            
            current.melody.push({f:f, idx:i, len:duration});
            
            let startBeat = Math.floor(current.beatIdx);
            let endBeat = Math.floor(current.beatIdx + duration - 0.01); 
            
            const startBox = document.getElementById(`beat-${startBeat}`);
            if(startBox) {
                const subNote = document.createElement('div');
                subNote.className = 'sub-note filled';
                subNote.style.height = `${(i+1)*10}%`;
                subNote.style.width = visualWidth;
                startBox.appendChild(subNote);
                startBox.classList.add('active');
            }

            for(let b = startBeat + 1; b <= endBeat; b++) {
                const nextBox = document.getElementById(`beat-${b}`);
                if(nextBox) {
                    const subNote = document.createElement('div');
                    subNote.className = 'sub-note filled';
                    subNote.style.height = `${(i+1)*10}%`; 
                    subNote.style.width = '100%';
                    subNote.style.opacity = '0.5'; 
                    nextBox.appendChild(subNote);
                    nextBox.classList.add('active');
                }
            }

            current.beatIdx += duration;

            if(current.beatIdx >= 3.99) { 
                document.getElementById('status-msg').innerText="ì™„ì„±! ë³€ì£¼ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”"; 
                document.getElementById('btn-save').classList.remove('hidden'); 
                previewMelody();
            }
        }

        function resetMelody(){ 
            current.melody=[]; current.beatIdx=0;
            document.querySelectorAll('.beat-box').forEach(b => { b.innerHTML=''; b.classList.remove('active'); });
            document.getElementById('btn-save').classList.add('hidden'); 
            document.getElementById('status-msg').innerText="1ë§ˆë”” ë©œë¡œë””ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì´ 4ë°•ì)";
        }
        function previewIfReady(){ if(current.beatIdx>=3.9) previewMelody(); }

        function getExpandedMelody(baseMelody, rVars, pVars) {
            let expanded = [];
            const getBaseNote = (nIdx) => baseMelody[nIdx % baseMelody.length];
            
            const applyPitch = (noteObj, pType) => {
                let newIdx = noteObj.idx;
                if(pType === 'up1') newIdx += 1;
                else if(pType === 'up2') newIdx += 2;
                else if(pType === 'down1') newIdx -= 1;
                else if(pType === 'invert') newIdx = 7 - noteObj.idx; 
                if(newIdx < 0) newIdx = 0; if(newIdx > 11) newIdx = 11;
                return { f: scale[newIdx].f, len: noteObj.len, idx: newIdx };
            };

            baseMelody.forEach(n => expanded.push(n));

            for(let i=0; i<3; i++) {
                let rType = rVars[i];
                let pType = pVars[i];
                
                if(rType === 'ending') {
                    let rootFreq = scale[0].f;
                    if(pType === 'up1') rootFreq *= 2;      
                    else if(pType === 'down1') rootFreq /= 2; 
                    expanded.push({f: rootFreq, idx: 0, len: 4.0});
                    continue; 
                }

                let barNotes = [];
                if(rType === 'repeat') { baseMelody.forEach(n => barNotes.push({...n})); } 
                else if(rType === 'quarter') { 
                    for(let k=0; k<4; k++) { let n = getBaseNote(k); barNotes.push({f: n.f, idx: n.idx, len: 1.0}); }
                } 
                else if(rType === 'eighth') { 
                    for(let k=0; k<8; k++) { let n = getBaseNote(Math.floor(k/2)); barNotes.push({f: n.f, idx: n.idx, len: 0.5}); }
                } 
                else if(rType === 'sixteenth') { 
                    for(let k=0; k<16; k++) { let n = getBaseNote(Math.floor(k/4)); barNotes.push({f: n.f, idx: n.idx, len: 0.25}); }
                }
                else if(rType === 'swing') { 
                    for(let k=0; k<4; k++) { let n = getBaseNote(k); barNotes.push({f: n.f, idx: n.idx, len: 0.66, isSwing:true}); barNotes.push({f: n.f, idx: n.idx, len: 0.34, isSwing:true}); }
                } 

                let shiftedNotes = barNotes.map(n => applyPitch(n, pType));
                shiftedNotes.forEach(n => expanded.push(n));
            }
            return expanded;
        }

        function previewSingleBar(barNum) {
            stopAllSound();
            const tempo = parseFloat(document.getElementById('tempo-slider').value);
            const beatTime = 0.5 / tempo;
            const now = audioCtx.currentTime;
            
            let full = getExpandedMelody(current.melody, current.rhythmVars, current.pitchVars);
            let accumulated = 0;
            let targetStart = (barNum - 1) * 4.0;
            let targetEnd = targetStart + 4.0;
            let barNotes = [];
            full.forEach(n => { if(accumulated >= targetStart && accumulated < targetEnd) { barNotes.push(n); } accumulated += n.len; });

            let cursor = 0;
            let localAccum = 0;
            barNotes.forEach(n => {
                let dur = n.len;
                playMultiSound(current.instruments, n.f, now + cursor, dur * beatTime * 0.9, localAccum);
                cursor += dur * beatTime;
                localAccum += dur;
            });
        }

        function previewMelody() {
            stopAllSound();
            const tempo = parseFloat(document.getElementById('tempo-slider').value);
            const beatTime = 0.5 / tempo;
            const now = audioCtx.currentTime;
            const fullMelody = getExpandedMelody(current.melody, current.rhythmVars, current.pitchVars);

            let cursorTime = 0;
            let accumulatedBeat = 0;
            
            fullMelody.forEach((n, i) => {
                let realDur = n.len * beatTime; 
                playMultiSound(current.instruments, n.f, now + cursorTime, realDur * 0.9, accumulatedBeat);
                cursorTime += realDur;
                accumulatedBeat += n.len;
            });
        }

        function saveBlock() {
            current.text = document.getElementById('preview-msg').value; 
            timeline.push(JSON.parse(JSON.stringify(current)));
            let instDisplay = current.instruments.map(i => i === 'piano' ? 'ğŸ¹' : i === 'violin' ? 'ğŸ»' : i === 'cello' ? 'ğŸ»(C)' : i === 'flute' ? 'ğŸŒ¬ï¸' : 'ğŸªµ').join('');
            
            const d=document.createElement('div'); d.className='story-block'; d.style.borderLeftColor=current.color;
            d.innerHTML=`<div><b>${current.text}</b></div><div><span style="font-size:0.8em; background:#ccc; color:white; padding:3px 8px; border-radius:10px;">${instDisplay} | ${current.rhythm}</span></div>`;
            document.getElementById('timeline-list').appendChild(d); document.getElementById('btn-play-all').classList.remove('hidden');
            document.getElementById('btn-stop-all').classList.remove('hidden');
            stopDemo(); resetMelody(); nextStep(1);
            
            document.getElementById('input-when').value=''; document.getElementById('input-where').value=''; 
            document.getElementById('input-who').value=''; document.getElementById('input-what').value='';
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.querySelector('.tab-btn').classList.add('active');
            document.querySelectorAll('.big-input').forEach(i=>i.classList.add('hidden')); document.getElementById('input-when').classList.remove('hidden');
        }

        function playWholeStory() {
            stopAllSound();
            if(audioCtx.state==='suspended')audioCtx.resume();
            let accTime=0; const now=audioCtx.currentTime+0.1;
            
            timeline.forEach((blk, idx) => {
                const tempo = 1.0; 
                const beatTime = 0.5 / blk.tempo;
                const fullMelody = getExpandedMelody(blk.melody, blk.rhythmVars, blk.pitchVars);
                
                let totalDur = 0;
                fullMelody.forEach(n => totalDur += (n.len * beatTime));
                
                const start = now + accTime;

                let to1 = setTimeout(() => { document.querySelectorAll('.story-block').forEach((b,i)=>b.style.background=i===idx?'#ffeaa7':'#f1f2f6'); }, accTime*1000);
                activeTimeouts.push(to1);

                const rData = rhythmData[blk.rhythm];
                const loopCount = 4; 
                for(let b=0; b<loopCount; b++) {
                    rData.loop.forEach(evt => {
                        const t = start + (b * 4 * beatTime) + (evt.t * beatTime); 
                        if(t < start + totalDur) {
                            if(evt.i==='kick') playKick(t); else if(evt.i==='snare') playSnare(t); else playChord(C_CHORD, t, 0.2);
                        }
                    });
                }

                let cursor = 0;
                let accumulatedBeat = 0;
                fullMelody.forEach(n => {
                    let realDur = n.len * beatTime;
                    let insts = Array.isArray(blk.instruments) ? blk.instruments : [blk.instrument || 'piano'];
                    
                    playMultiSound(insts, n.f, start + cursor, realDur * 0.8, accumulatedBeat);
                    
                    cursor += realDur;
                    accumulatedBeat += n.len;
                });

                accTime += totalDur;
            });
            let to2 = setTimeout(() => document.querySelectorAll('.story-block').forEach(b=>b.style.background='#f1f2f6'), accTime*1000);
            activeTimeouts.push(to2);
        }
    </script>
</body>
</html>